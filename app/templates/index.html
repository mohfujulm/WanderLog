<!DOCTYPE html>
<html>
<head>
    <title>Wanderlog Map</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
      
        :root { --app-font-family: 'Raleway', 'Verdana', sans-serif; }

        body, html {    height: 100%; 
                        font-family: var(--app-font-family); 
                        overflow: hidden; }

        button, input, select { font-family: inherit; }

        #map-container {    position: relative; 
                            width: 100vw; 
                            height: 100vh; }

        #map {  width: 100%;
                height: 100%; }

        .leaflet-marker-icon.marker-pin-icon {
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.25));
        }

        .menu-container {   position: absolute;
                            top: 24px;
                            right: 24px;
                            z-index: 1000;
                            display: flex;
                            flex-direction: column;
                            align-items: flex-end;
                            gap: 16px;
                            width: auto; }

        .menu-container.open {  gap: 20px; }

        .menu-toggle {  align-self: flex-end;
                        cursor: pointer;
                        user-select: none;
                        padding: 18px 12px; 
                        background: rgba(255,255,255,0.95); 
                        border-radius: 18px; 
                        box-shadow: 0 6px 18px rgba(0,0,0,0.12); 
                        transition: background 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease; 
                        border: none; 
                        display: inline-flex; 
                        flex-direction: row; 
                        align-items: center; 
                        justify-content: center; 
                        gap: 8px; 
                        text-transform: uppercase; 
                        letter-spacing: 0.12em; 
                        color: #333; 
                        writing-mode: vertical-rl; 
                        text-orientation: mixed; 
                        font-weight: 500; }

        .menu-toggle:hover {    background: rgba(255,255,255,1); 
                                transform: translateY(-2px); 
                                box-shadow: 0 6px 20px rgba(0,0,0,0.25); }

        .menu-toggle:focus { outline: 2px solid rgba(0,120,212,0.6); outline-offset: 2px; }

        .menu-toggle .menu-toggle-icon {    display: inline-flex; 
                                            align-items: center; 
                                            justify-content: center; 
                                            width: 20px; 
                                            height: 20px; 
                                            line-height: 1; 
                                            writing-mode: horizontal-tb; 
                                            flex-shrink: 0; }

        .menu-toggle .menu-toggle-icon img {    width: 100%; 
                                                height: 100%; 
                                                object-fit: contain; 
                                                display: block; }

        .menu-toggle .menu-toggle-text { font-size: 12px; }

        .menu-container.open .menu-toggle { align-self: flex-end; 
                                            margin-left: auto; 
                                            writing-mode: horizontal-tb; 
                                            flex-direction: row; 
                                            padding: 10px 16px; 
                                            border-radius: 14px; 
                                            gap: 8px; 
                                            letter-spacing: 0.08em;
                                            box-shadow: 0 4px 14px rgba(0,0,0,0.15); }
        .menu-container.open .menu-toggle .menu-toggle-text { font-size: 14px; }

        .overlay-controls { display: flex;
                            flex-direction: column;
                            align-items: stretch;
                            gap: 16px;
                            opacity: 0;
                            transform: translateY(-8px) scale(0.98);
                            transform-origin: top right;
                            transition: opacity 0.25s ease, transform 0.25s ease;
                            pointer-events: none;
                            background: rgba(255,255,255,0.96);
                            border-radius: 20px;
                            padding: 24px 24px 20px;
                            box-shadow: 0 12px 32px rgba(0,0,0,0.22);
                            backdrop-filter: blur(14px);
                            width: min(360px, calc(100vw - 64px));
                            max-height: min(80vh, 640px);
                            overflow-y: auto; }

        .overlay-tabs {    display: flex;
                            align-items: center;
                            justify-content: stretch;
                            gap: 6px;
                            background: rgba(243, 244, 246, 0.7);
                            padding: 6px;
                            border-radius: 18px; }

        .overlay-tab {     flex: 1 1 0;
                            border: none;
                            background: transparent;
                            border-radius: 12px;
                            padding: 10px 16px;
                            font-size: 13px;
                            font-weight: 600;
                            letter-spacing: 0.08em;
                            text-transform: uppercase;
                            cursor: pointer;
                            color: #4b5563;
                            transition: background 0.2s ease, color 0.2s ease, transform 0.2s ease;
                            text-align: center; }

        .overlay-tab:hover { background: rgba(255,255,255,0.8); }

        .overlay-tab:focus-visible { outline: 2px solid rgba(0,120,212,0.65); outline-offset: 2px; }

        .overlay-tab[aria-selected="true"] { background: #111827;
                                            color: #fff;
                                            box-shadow: 0 6px 18px rgba(17,24,39,0.18);
                                            transform: translateY(-1px); }

        .overlay-tab-panel {   display: flex;
                                flex-direction: column;
                                gap: 12px; }

        .overlay-tab-panel[hidden] { display: none; }

        .trips-placeholder {    display: flex;
                                flex-direction: column;
                                gap: 8px;
                                padding: 18px 16px;
                                border-radius: 14px;
                                background: rgba(249,250,251,0.92);
                                color: #1f2937;
                                text-align: right; }

        .trips-placeholder h3 { font-size: 16px;
                                letter-spacing: 0.06em;
                                text-transform: uppercase; }

        .trips-placeholder p {  font-size: 13px;
                                line-height: 1.5; }

        .trip-panel {           display: flex;
                                flex-direction: column;
                                gap: 16px; }

        .trip-panel-header {    display: flex;
                                flex-direction: column;
                                gap: 6px;
                                text-align: right; }

        .trip-panel-heading {   font-size: 18px;
                                letter-spacing: 0.08em;
                                text-transform: uppercase;
                                color: #111827; }

        .trip-panel-subtitle {  font-size: 13px;
                                color: #6b7280;
                                line-height: 1.4; }

        .trip-list-view {      display: flex;
                                flex-direction: column;
                                gap: 16px; }

        .trip-list-view[hidden] {
            display: none;
        }

        .trip-detail {         display: flex;
                                flex-direction: column;
                                gap: 16px; }

        .trip-detail[hidden] { display: none; }

        .trip-detail-back {    align-self: flex-end;
                                border: none;
                                background: rgba(243,244,246,0.92);
                                border-radius: 999px;
                                padding: 8px 16px;
                                font-size: 12px;
                                font-weight: 600;
                                letter-spacing: 0.08em;
                                text-transform: uppercase;
                                color: #111827;
                                cursor: pointer;
                                transition: background 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease; }

        .trip-detail-back:hover { background: rgba(229,231,235,0.95);
                                   transform: translateY(-1px);
                                   box-shadow: 0 4px 12px rgba(15,23,42,0.14); }

        .trip-detail-back:focus-visible { outline: 2px solid rgba(17,24,39,0.65);
                                           outline-offset: 2px; }

        .trip-detail-header {   display: flex;
                                flex-direction: column;
                                gap: 12px;
                                text-align: right; }

        .trip-detail-titles {   display: flex;
                                flex-direction: column;
                                gap: 6px; }

        .trip-detail-heading {  font-size: 17px;
                                letter-spacing: 0.06em;
                                text-transform: uppercase;
                                color: #111827; }

        .trip-detail-subtitle { font-size: 13px;
                                color: #6b7280;
                                line-height: 1.4; }

        .trip-detail-meta {     display: flex;
                                gap: 10px;
                                justify-content: flex-end;
                                flex-wrap: wrap;
                                font-size: 12px;
                                color: #4b5563; }

        .trip-detail-meta-entry {   display: inline-flex;
                                    align-items: center;
                                    gap: 4px; }

        .trip-detail-meta-entry time { color: inherit; }

        .trip-detail-controls { display: flex;
                                flex-direction: column;
                                gap: 12px; }

        .trip-controls {        display: flex;
                                flex-direction: column;
                                gap: 12px; }

        .trip-search {          display: flex;
                                flex-direction: column;
                                gap: 6px;
                                text-align: right; }

        .trip-search-label {    font-size: 12px;
                                text-transform: uppercase;
                                letter-spacing: 0.08em;
                                color: #4b5563;
                                font-weight: 600; }

        .trip-search input {    border: 1px solid #d1d5db;
                                border-radius: 12px;
                                padding: 10px 14px;
                                font-size: 14px;
                                background: rgba(255,255,255,0.95);
                                text-align: right;
                                transition: border-color 0.2s ease, box-shadow 0.2s ease; }

        .trip-search input:focus {   outline: none;
                                    border-color: #111827;
                                    box-shadow: 0 0 0 3px rgba(17,24,39,0.15); }

        .trip-sort {            display: flex;
                                gap: 8px;
                                justify-content: flex-end;
                                align-items: stretch;
                                flex-wrap: wrap; }

        .trip-sort-field {      display: flex;
                                flex-direction: column;
                                gap: 6px;
                                text-align: right; }

        .trip-sort-label {      font-size: 12px;
                                text-transform: uppercase;
                                letter-spacing: 0.08em;
                                color: #4b5563;
                                font-weight: 600; }

        .trip-sort select {     border: 1px solid #d1d5db;
                                border-radius: 12px;
                                padding: 10px 14px;
                                font-size: 14px;
                                background: rgba(255,255,255,0.95);
                                text-align: right;
                                min-width: 140px;
                                transition: border-color 0.2s ease, box-shadow 0.2s ease; }

        .trip-sort select:focus {   outline: none;
                                    border-color: #111827;
                                    box-shadow: 0 0 0 3px rgba(17,24,39,0.15); }

        .trip-sort-direction {  border: none;
                                border-radius: 12px;
                                padding: 10px 16px;
                                background: #111827;
                                color: #fff;
                                font-size: 13px;
                                font-weight: 600;
                                cursor: pointer;
                                transition: background 0.2s ease, transform 0.2s ease;
                                letter-spacing: 0.06em;
                                text-transform: uppercase; }

        .trip-sort-direction:hover {   background: #1f2937;
                                        transform: translateY(-1px); }

        .trip-sort-direction:focus-visible { outline: 2px solid rgba(17,24,39,0.65);
                                            outline-offset: 2px; }

        .trip-list-container {  display: flex;
                                flex-direction: column;
                                gap: 10px; }

        .trip-list {            display: flex;
                                flex-direction: column;
                                gap: 12px;
                                max-height: 320px;
                                overflow-y: auto;
                                padding-right: 6px; }

        .trip-list[hidden] {    display: none; }

        .trip-list-message {    font-size: 13px;
                                color: #4b5563;
                                text-align: right;
                                line-height: 1.5;
                                background: rgba(249,250,251,0.9);
                                border-radius: 12px;
                                padding: 14px 16px; }

        .trip-list-message-error {  color: #b3261e;
                                    background: rgba(254,242,242,0.85);
                                    border: 1px solid rgba(179,38,30,0.25); }

        .trip-location-list-container {   display: flex;
                                          flex-direction: column;
                                          gap: 10px; }

        .trip-location-list {     display: flex;
                                    flex-direction: column;
                                    gap: 12px;
                                    max-height: 320px;
                                    overflow-y: auto;
                                    padding-right: 6px; }

        .trip-location-list[hidden] {
            display: none;
        }

        .trip-location-item {     display: flex;
                                    flex-direction: column;
                                    gap: 8px;
                                    background: rgba(249,250,251,0.95);
                                    padding: 14px 16px;
                                    border-radius: 16px;
                                    border: 1px solid rgba(229,231,235,0.85);
                                    box-shadow: 0 3px 12px rgba(15,23,42,0.08);
                                    text-align: right; }

        .trip-location-item-missing {
            border-style: dashed;
            border-color: rgba(209,213,219,0.9);
            background: rgba(249,250,251,0.6);
            color: #6b7280;
        }

        .trip-location-name {     font-size: 15px;
                                    font-weight: 600;
                                    color: #111827;
                                    word-break: break-word; }

        .trip-location-item-missing .trip-location-name {
            color: #4b5563;
        }

        .trip-location-meta {     display: flex;
                                    flex-direction: column;
                                    gap: 6px;
                                    font-size: 12px;
                                    color: #4b5563; }

        .trip-location-meta-row { display: inline-flex;
                                    gap: 8px;
                                    justify-content: flex-end;
                                    flex-wrap: wrap; }

        .trip-location-meta-entry {   display: inline-flex;
                                        align-items: center;
                                        gap: 4px; }

        .trip-location-meta-entry time { color: inherit; }

        .trip-location-meta-label { font-size: 11px;
                                    letter-spacing: 0.06em;
                                    text-transform: uppercase;
                                    color: #6b7280; }

        .trip-location-tag {      display: inline-flex;
                                    align-items: center;
                                    justify-content: center;
                                    border-radius: 999px;
                                    padding: 2px 8px;
                                    font-size: 11px;
                                    letter-spacing: 0.06em;
                                    text-transform: uppercase;
                                    background: rgba(17,24,39,0.08);
                                    color: #111827; }

        .trip-location-missing-note {    font-size: 12px;
                                         line-height: 1.5;
                                         color: #6b7280; }

        .trip-item {            display: flex;
                                flex-direction: column;
                                gap: 8px;
                                background: rgba(249,250,251,0.95);
                                padding: 14px 16px;
                                border-radius: 16px;
                                border: 1px solid rgba(229,231,235,0.85);
                                box-shadow: 0 3px 12px rgba(15,23,42,0.08);
                                text-align: right;
                                cursor: pointer;
                                transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease; }

        .trip-item:hover {      transform: translateY(-1px);
                                box-shadow: 0 6px 16px rgba(15,23,42,0.12); }

        .trip-item:focus-visible { outline: 2px solid rgba(17,24,39,0.65);
                                   outline-offset: 3px; }

        .trip-item-active {     border-color: rgba(17,24,39,0.6);
                                box-shadow: 0 8px 20px rgba(17,24,39,0.18);
                                background: rgba(17,24,39,0.05); }

        .trip-item-active .trip-item-name {
            color: #0f172a;
        }

        .trip-item-name {       font-size: 15px;
                                font-weight: 600;
                                color: #111827;
                                word-break: break-word; }

        .trip-item-meta {       display: flex;
                                gap: 10px;
                                justify-content: flex-end;
                                flex-wrap: wrap;
                                font-size: 12px;
                                color: #4b5563; }

        .trip-item-meta-entry { display: inline-flex;
                                align-items: center;
                                gap: 4px; }

        .trip-item-meta-entry time {  color: inherit; }


        .menu-container.open .overlay-controls { opacity: 1;
                                                transform: translateY(0) scale(1);
                                                pointer-events: auto; }

        .overlay-button {   background: rgba(255,255,255,0.95); 
                            color: #333; 
                            border: none; 
                            padding: 12px 18px; 
                            font-size: 14px; 
                            font-weight: 500; 
                            border-radius: 15px; 
                            cursor: pointer; 
                            transition: all 0.3s ease; 
                            box-shadow: 3px 4px 0px 0px rgba(0, 0, 0, 0.15); 
                            backdrop-filter: blur(10px); 
                            border: 1px solid rgba(255,255,255,0.2); 
                            min-width: 180px; 
                            text-align: right; 
                            width: 100%; }

        .overlay-section-title { align-self: stretch;
                                 padding-top: 3px;
                                 font-size: 13px;
                                 font-weight: 600;
                                 letter-spacing: 0.08em;
                                 text-transform: uppercase;
                                 color: #444;
                                 text-align: right; }

        .overlay-button:hover {     background: rgba(255,255,255,1); 
                                    transform: translateY(-2px); 
                                    box-shadow: 4px 5px 0px 0px rgba(0, 0, 0, 0.15); }

        .overlay-button:active {    transform: translateY(0); 
                                    box-shadow: 4px 5px 0px 0px rgba(0, 0, 0, 0.15); }

        .checkbox-group {               display: flex;
                                        flex-direction: column;
                                        gap: 4px;
                                        align-self: stretch; }

        .checkbox-group label {         display: flex; 
                                        align-items: center; 
                                        gap: 8px; 
                                        font-size: 14px; 
                                        justify-content: space-between; }

        .checkbox-group label span {    flex: 1;
                                        min-width: 0;
                                        text-align: right; }

        .checkbox-group label input { flex-shrink: 0; }

        .date-filter-group {            display: flex;
                                        flex-direction: column;
                                        gap: 8px;
                                        align-self: stretch; }

        .date-filter-group label {      display: flex;
                                        align-items: center;
                                        gap: 8px;
                                        font-size: 14px;
                                        justify-content: space-between; }

        .date-filter-group label span { flex: 1;
                                        text-align: right; }

        .date-filter-group input {      border: 1px solid #ccc;
                                        border-radius: 8px;
                                        padding: 6px 10px;
                                        font-size: 14px;
                                        font-family: inherit; }

        .date-filter-actions {          display: flex;
                                        justify-content: flex-end; }

        .date-filter-clear {            background: none;
                                        border: none;
                                        color: #0078d4;
                                        font-size: 13px;
                                        font-weight: 600;
                                        cursor: pointer;
                                        padding: 0; }

        .date-filter-clear:hover {      text-decoration: underline; }

        .date-filter-clear:focus {      outline: 2px solid rgba(0,120,212,0.6);
                                        outline-offset: 2px; }

        #status {   position: absolute; 
                    bottom: 20px; 
                    left: 50%; 
                    transform: translateX(-50%); 
                    background: rgba(255,255,255,0.9); 
                    padding: 8px 12px; 
                    border-radius: 4px; 
                    display: none; 
                    font-size: 14px; 
                    z-index: 1000; }

        #status.success {   border: 1px solid #4CAF50; 
                            color: #4CAF50; }
                    
        #status.error {     border: 1px solid #F44336; 
                            color: #F44336; }

        .loading-overlay {  position: absolute; 
                            top: 0; 
                            left: 0; 
                            width: 100%; 
                            height: 100%; 
                            background: rgba(255,255,255,0.8); 
                            display: none; 
                            align-items: center; 
                            justify-content: center; 
                            z-index: 2000; }

        .loading-spinner {  text-align: center; 
                            font-size: 18px; }

        .spinner {          border: 4px solid #f3f3f3; 
                            border-top: 4px solid #0078D7; 
                            border-radius: 50%; 
                            width: 40px; 
                            height: 40px; 
                            animation: spin 1s linear infinite; 
                            margin: 0 auto 10px; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .modal-overlay {    position: absolute; 
                            inset: 0; background: rgba(0,0,0,0.45); 
                            display: none; 
                            align-items: center; 
                            justify-content: center; 
                            z-index: 3000; 
                            padding: 20px; }

        .modal-overlay.open { display: flex; }

        .modal-content {    background: #fff; 
                            border-radius: 12px; 
                            width: min(420px, 100%); 
                            box-shadow: 0 12px 32px rgba(0,0,0,0.25); 
                            padding: 24px; 
                            display: flex; 
                            flex-direction: column; 
                            gap: 16px; 
                            outline: none; }

        .modal-content h2 { font-size: 20px; 
                            margin-bottom: 4px; }

        .modal-content form { display: flex; 
                            flex-direction: column; 
                            gap: 14px; }

        .form-group {       display: flex; 
                            flex-direction: column; 
                            gap: 6px; }

        .form-group label { font-weight: 600; 
                            font-size: 14px; 
                            color: #333; }

        .form-group input, .form-group select { padding: 10px;
                                                border: 1px solid #ccc;
                                                border-radius: 8px;
                                                font-size: 14px;
                                                width: 100%; }

        .form-helper-text {
            font-size: 12px;
            color: #555;
            line-height: 1.4;
        }

        .alias-modal-original {
            display: block;
            margin-top: 2px;
            font-weight: 600;
            color: #1f2937;
        }

        .modal-actions {    display: flex; 
                            justify-content: flex-end; 
                            gap: 12px; 
                            margin-top: 8px; }

        .modal-button {     border: none; 
                            border-radius: 8px; 
                            padding: 10px 18px; 
                            font-size: 14px; 
                            cursor: pointer; 
                            transition: background 0.2s ease, transform 0.2s ease; 
                            font-weight: 600; }

        .modal-button.secondary { background: #e0e0e0; color: #333; }
        .modal-button.secondary:hover { background: #d5d5d5; }
        .modal-button.primary { background: #0078d4; color: #fff; }
        .modal-button.primary:hover { background: #0062ad; transform: translateY(-1px); }
        .modal-button:focus { outline: 2px solid #0078d4; outline-offset: 2px; }

        .archived-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 320px;
            overflow-y: auto;
        }

        .archived-empty {
            font-size: 12px;
            color: #555;
            text-align: center;
        }

        .archived-item {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background: #f9fafb;
        }

        .archived-item-details {
            display: flex;
            flex-direction: column;
            font-size: 12px;
            gap: 4px;
            flex: 1;
            min-width: 0;
        }

        .archived-item-place {
            font-weight: 500;
            color: #222;
            word-break: break-word;
        }

        .archived-item-meta {
            font-size: 12px;
            color: #555;
        }

        .archived-item-place-original {
            font-size: 11px;
            color: #6b7280;
        }

        .archived-item-action {
            align-self: center;
            white-space: nowrap;
        }

        .archived-item-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: stretch;
        }

        .marker-popup {
            font-family: var(--app-font-family);
            min-width: 220px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            color: #222;
        }

        .marker-popup-row {
            display: flex;
            flex-direction: column;
            gap: 2px;
            font-size: 13px;
            line-height: 1.4;
        }

        .marker-popup-label {
            font-weight: 600;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            font-size: 11px;
        }

        .marker-popup-value {
            color: #1a1a1a;
            word-break: break-word;
        }

        .marker-actions {
            display: flex;
            gap: 8px;
            margin-top: 4px;
            flex-wrap: wrap;
        }

        .marker-action {
            flex: 1 1 0;
            border: none;
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.2s ease;
            font-weight: 600;
        }

        .marker-action:focus {
            outline: 2px solid rgba(0,120,212,0.45);
            outline-offset: 2px;
        }

        .marker-action:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .marker-action-archive {
            background: #eef2ff;
            color: #314192;
        }

        .marker-action-archive:hover:not(:disabled) {
            background: #dce4ff;
            transform: translateY(-1px);
        }

        .marker-action-alias {
            background: #e6f4ea;
            color: #1b5e20;
        }

        .marker-action-alias:hover:not(:disabled) {
            background: #d0ecd9;
            transform: translateY(-1px);
        }

        .marker-action-delete {
            background: #fdecea;
            color: #b3261e;
        }

        .marker-action-delete:hover:not(:disabled) {
            background: #fbd6d2;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
<div id="map-container">
    <div id="map"></div>
    <input type="file" id="timelineFile" accept=".json" style="display:none" onchange="updateMap()">
    <div class="menu-container" role="complementary" aria-label="Map controls panel">
        <button class="menu-toggle" type="button" onclick="toggleMenu()" aria-label="Open menu" aria-expanded="false" aria-controls="menuControls">
            <span class="menu-toggle-icon" aria-hidden="true">
                <img src="{{ url_for('static', filename='assets/menu-icon.svg') }}" alt="" aria-hidden="true">
            </span>
            <span class="menu-toggle-text">Menu</span>
        </button>
        <div class="overlay-controls" id="menuControls" aria-hidden="true" inert>
            <div class="overlay-tabs" role="tablist" aria-label="Menu sections">
                <button type="button" class="overlay-tab" role="tab" id="menuTabTrips" aria-selected="false" aria-controls="menuPanelTrips" tabindex="-1">Trips</button>
                <button type="button" class="overlay-tab" role="tab" id="menuTabControls" aria-selected="true" aria-controls="menuPanelControls">Settings</button>
            </div>
            <div id="menuPanelControls" class="overlay-tab-panel" role="tabpanel" aria-labelledby="menuTabControls">
                <button class="overlay-button" onclick="document.getElementById('timelineFile').click()">Import Timeline Data</button>
                <button class="overlay-button" onclick="addManualPoint()">Add a Location Manually</button>
                <button class="overlay-button" onclick="clearMap()">Clear Map</button>
                <button class="overlay-button" onclick="refreshMap()">Refresh Map</button>
                <button class="overlay-button" onclick="viewArchivedPoints()">View Archived Points</button>
                <h2 class="overlay-section-title" id="filtersTitle">Filters</h2>
                <div id="sourceTypeFilters" class="checkbox-group" role="group" aria-labelledby="filtersTitle"></div>
                <h2 class="overlay-section-title" id="dateFiltersTitle">Date Range</h2>
                <div class="date-filter-group" id="dateFilters" role="group" aria-labelledby="dateFiltersTitle">
                    <label for="filterStartDate">
                        <span>Start Date</span>
                        <input type="date" id="filterStartDate" name="filterStartDate">
                    </label>
                    <label for="filterEndDate">
                        <span>End Date</span>
                        <input type="date" id="filterEndDate" name="filterEndDate">
                    </label>
                    <div class="date-filter-actions">
                        <button type="button" class="date-filter-clear" id="clearDateFilters">Clear Dates</button>
                    </div>
                </div>
            </div>
            <div id="menuPanelTrips" class="overlay-tab-panel" role="tabpanel" aria-labelledby="menuTabTrips" hidden>
                <div class="trip-panel">
                    <div class="trip-panel-header">
                        <h3 class="trip-panel-heading">Trips</h3>
                        <p class="trip-panel-subtitle">Browse every journey you've created and quickly locate the one you need.</p>
                    </div>
                    <div id="tripListView" class="trip-list-view">
                        <div class="trip-controls">
                            <label class="trip-search">
                                <span class="trip-search-label">Search</span>
                                <input type="search" id="tripSearchInput" name="tripSearch" placeholder="Search trips" autocomplete="off">
                            </label>
                            <div class="trip-sort" role="group" aria-label="Trip sorting">
                                <label class="trip-sort-field" for="tripSortField">
                                    <span class="trip-sort-label">Sort by</span>
                                    <select id="tripSortField" name="tripSortField">
                                        <option value="name">Name</option>
                                        <option value="updated_at">Date updated</option>
                                    </select>
                                </label>
                                <button type="button" class="trip-sort-direction" id="tripSortDirection" aria-label="Sort descending">
                                    Ascending
                                </button>
                            </div>
                        </div>
                        <div class="trip-list-container">
                            <div id="tripListLoading" class="trip-list-message" role="status" aria-live="polite" hidden>Loading trips...</div>
                            <div id="tripListError" class="trip-list-message trip-list-message-error" role="alert" hidden></div>
                            <div id="tripListEmpty" class="trip-list-message" aria-live="polite" hidden>No trips yet. Assign a location to begin your first journey.</div>
                            <div id="tripList" class="trip-list" role="list" hidden></div>
                        </div>
                    </div>
                    <div id="tripDetailView" class="trip-detail" hidden aria-hidden="true">
                        <button type="button" class="trip-detail-back" id="tripDetailBack">Back to trips</button>
                        <div class="trip-detail-header">
                            <div class="trip-detail-titles">
                                <h4 class="trip-detail-heading" id="tripDetailTitle">Trip details</h4>
                                <p class="trip-detail-subtitle" id="tripDetailSubtitle">Review the places assigned to this journey.</p>
                            </div>
                            <div class="trip-detail-meta" aria-live="polite">
                                <span id="tripDetailCount" class="trip-detail-meta-entry"></span>
                                <span id="tripDetailUpdated" class="trip-detail-meta-entry" hidden></span>
                            </div>
                        </div>
                        <div class="trip-detail-controls">
                            <label class="trip-search">
                                <span class="trip-search-label">Search</span>
                                <input type="search" id="tripLocationSearchInput" name="tripLocationSearch" placeholder="Search locations" autocomplete="off">
                            </label>
                            <div class="trip-sort" role="group" aria-label="Location sorting">
                                <label class="trip-sort-field" for="tripLocationSortField">
                                    <span class="trip-sort-label">Sort by</span>
                                    <select id="tripLocationSortField" name="tripLocationSortField">
                                        <option value="date">Date visited</option>
                                        <option value="name">Name</option>
                                    </select>
                                </label>
                                <button type="button" class="trip-sort-direction" id="tripLocationSortDirection" aria-label="Sort descending">
                                    Ascending
                                </button>
                            </div>
                        </div>
                        <div class="trip-location-list-container">
                            <div id="tripLocationLoading" class="trip-list-message" role="status" aria-live="polite" hidden>Loading locations...</div>
                            <div id="tripLocationError" class="trip-list-message trip-list-message-error" role="alert" hidden></div>
                            <div id="tripLocationEmpty" class="trip-list-message" aria-live="polite" hidden>No locations assigned to this trip yet.</div>
                            <div id="tripLocationList" class="trip-location-list" role="list" hidden></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="status"></div>
    <div class="loading-overlay" id="loading">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <div>Loading...</div>
        </div>
    </div>
    <div id="manualPointModal" class="modal-overlay" aria-hidden="true" hidden>
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="manualPointTitle" tabindex="-1">
            <h2 id="manualPointTitle">Add Data Point</h2>
            <form id="manualPointForm">
                <div class="form-group">
                    <label for="manualPlace">Place Name</label>
                    <input type="text" id="manualPlace" name="place_name" autocomplete="off" required>
                </div>
                <div class="form-group">
                    <label for="manualAlias">Custom Name (Optional)</label>
                    <input type="text" id="manualAlias" name="alias" maxlength="120" autocomplete="off" placeholder="e.g. Grandma's House">
                    <p class="form-helper-text">Leave blank to use the place name from your timeline.</p>
                </div>
                <div class="form-group">
                    <label for="manualDate">Date</label>
                    <input type="date" id="manualDate" name="start_date" required>
                </div>
                <div class="form-group">
                    <label for="manualLatitude">Latitude</label>
                    <input type="number" id="manualLatitude" name="latitude" step="any" required>
                </div>
                <div class="form-group">
                    <label for="manualLongitude">Longitude</label>
                    <input type="number" id="manualLongitude" name="longitude" step="any" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="modal-button secondary" id="manualPointCancel">Cancel</button>
                    <button type="submit" class="modal-button primary">Save</button>
                </div>
            </form>
        </div>
    </div>
    <div id="aliasModal" class="modal-overlay" aria-hidden="true" hidden>
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="aliasModalTitle" tabindex="-1">
            <h2 id="aliasModalTitle">Rename Location</h2>
            <form id="aliasForm">
                <div class="form-group">
                    <label for="aliasInput">Custom Name</label>
                    <input type="text" id="aliasInput" name="alias" maxlength="120" autocomplete="off" placeholder="Enter a nickname or leave blank">
                    <p class="form-helper-text">
                        Original place name:
                        <span id="aliasOriginalName" class="alias-modal-original"></span>
                    </p>
                </div>
                <div class="modal-actions">
                    <button type="button" class="modal-button secondary" id="aliasCancel">Cancel</button>
                    <button type="submit" class="modal-button primary">Save</button>
                </div>
            </form>
        </div>
    </div>
    <div id="tripAssignmentModal" class="modal-overlay" aria-hidden="true" hidden>
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="tripAssignmentTitle" tabindex="-1">
            <h2 id="tripAssignmentTitle">Add to Trip</h2>
            <form id="tripAssignmentForm">
                <div class="form-group">
                    <label for="tripSelect">Choose a Trip</label>
                    <select id="tripSelect" name="trip_id">
                        <option value="" disabled selected>Loading trips...</option>
                    </select>
                    <p class="form-helper-text" id="tripSelectHelper">
                        Select an existing trip or enter a name to create a new one.
                    </p>
                </div>
                <div class="form-group">
                    <label for="newTripName">Create New Trip</label>
                    <input type="text" id="newTripName" name="new_trip_name" maxlength="120" autocomplete="off" placeholder="e.g. Summer Getaway">
                    <p class="form-helper-text">Enter a new trip name to create it and add this location.</p>
                </div>
                <div class="modal-actions">
                    <button type="button" class="modal-button secondary" id="tripAssignmentCancel">Cancel</button>
                    <button type="submit" class="modal-button primary">Add to Trip</button>
                </div>
            </form>
        </div>
    </div>
    <div id="archivedPointsModal" class="modal-overlay" aria-hidden="true" hidden>
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="archivedPointsTitle" tabindex="-1">
            <h2 id="archivedPointsTitle">Archived Data Points</h2>
            <div id="archivedPointsList" class="archived-list" role="list">
                <p class="archived-empty">No archived data points.</p>
            </div>
            <div class="modal-actions">
                <button type="button" class="modal-button secondary" id="archivedPointsClose">Close</button>
            </div>
        </div>
    </div>
</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
const MAPBOX_TOKEN = "{{ mapbox_token }}";
const MENU_ICON_PATH = "{{ url_for('static', filename='assets/menu-icon.svg') }}";
const CLOSE_ICON_PATH = "{{ url_for('static', filename='assets/close-icon.svg') }}";
let map;
let markerCluster;
let manualPointForm;
let manualPointModalController = null;
let archivedPointsModalController = null;
let archivedPointsList = null;
let aliasForm;
let aliasModalController = null;
let aliasOriginalNameElement = null;
let aliasTargetMarkerId = null;
let aliasModalContext = { isArchived: false, triggerButton: null };
let tripAssignmentModalController = null;
let tripAssignmentForm = null;
let tripAssignmentPlaceId = null;
let tripSelectElement = null;
let newTripNameInput = null;
let tripSelectHelper = null;
let tripModalContext = { triggerButton: null };
let tripListContainer = null;
let tripListLoadingElement = null;
let tripListErrorElement = null;
let tripListEmptyElement = null;
let tripSearchInput = null;
let tripSortFieldSelect = null;
let tripSortDirectionButton = null;
let tripListView = null;
let tripDetailContainer = null;
let tripDetailBackButton = null;
let tripDetailTitleElement = null;
let tripDetailSubtitleElement = null;
let tripDetailCountElement = null;
let tripDetailUpdatedElement = null;
let tripLocationSearchInput = null;
let tripLocationSortFieldSelect = null;
let tripLocationSortDirectionButton = null;
let tripLocationListContainer = null;
let tripLocationLoadingElement = null;
let tripLocationErrorElement = null;
let tripLocationEmptyElement = null;

const TRIP_SORT_FIELD_NAME = 'name';
const TRIP_SORT_FIELD_UPDATED = 'updated_at';
const TRIP_SORT_DIRECTION_ASC = 'asc';
const TRIP_SORT_DIRECTION_DESC = 'desc';
const TRIP_NAME_FALLBACK = 'Untitled Trip';

const TRIP_LOCATION_SORT_FIELD_DATE = 'date';
const TRIP_LOCATION_SORT_FIELD_NAME = 'name';

const tripListState = {
    trips: [],
    searchTerm: '',
    sortField: TRIP_SORT_FIELD_NAME,
    sortDirection: TRIP_SORT_DIRECTION_ASC,
    initialised: false,
};

const tripDetailState = {
    initialised: false,
    selectedTripId: null,
    trip: null,
    locations: [],
    searchTerm: '',
    sortField: TRIP_LOCATION_SORT_FIELD_DATE,
    sortDirection: TRIP_SORT_DIRECTION_ASC,
    triggerElement: null,
    requestId: 0,
};

const tripLocationCache = new Map();

const tripDateFormatter = (() => {
    try {
        return new Intl.DateTimeFormat(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
    } catch (error) {
        return null;
    }
})();

const SOURCE_TYPE_LABELS = {
    google_timeline: 'Google Timeline',
    manual: 'Manual Entry',
};

const MARKER_ICON_PATHS = {
    google_timeline: "{{ url_for('static', filename='assets/marker-pin-blue.svg') }}",
    manual: "{{ url_for('static', filename='assets/marker-pin-orange.svg') }}",
    default: "{{ url_for('static', filename='assets/marker-pin-gray.svg') }}",
};

const MAX_ALIAS_LENGTH = 120;
const MAX_TRIP_NAME_LENGTH = 120;

const markerIconCache = new Map();

const HTML_ESCAPE_LOOKUP = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;',
};
const HTML_ESCAPE_REGEX = /[&<>"']/g;

function escapeHtml(value) {
    if (value === null || value === undefined) { return ''; }
    return String(value).replace(HTML_ESCAPE_REGEX, (match) => HTML_ESCAPE_LOOKUP[match] || match);
}

function escapeHtmlAttribute(value) {
    return escapeHtml(value).replace(/`/g, '&#96;');
}

function createPopupContent(markerData) {
    if (!markerData) { return ''; }

    const markerId = markerData.id || '';
    const safeId = escapeHtmlAttribute(markerId);
    const placeRaw = markerData.place ?? '';
    const placeClean = typeof placeRaw === 'string'
        ? placeRaw.trim()
        : String(placeRaw || '').trim();
    const aliasRaw = markerData.alias ?? '';
    const aliasClean = typeof aliasRaw === 'string'
        ? aliasRaw.trim()
        : String(aliasRaw || '').trim();
    const displayRaw = markerData.display_name ?? '';
    let displayClean = typeof displayRaw === 'string'
        ? displayRaw.trim()
        : String(displayRaw || '').trim();

    if (!displayClean) {
        displayClean = aliasClean || placeClean;
    }

    const hasAlias = aliasClean.length > 0;
    const nameLabel = hasAlias ? 'Alias' : 'Place Name';

    const place = escapeHtml(placeClean || 'Unknown');
    const displayName = escapeHtml(displayClean || 'Unknown');
    const sourceLabel = getSourceTypeLabel(markerData.source_type);
    const sourceRow = sourceLabel
        ? `<div class="marker-popup-row"><span class="marker-popup-label">Source</span><span class="marker-popup-value">${escapeHtml(sourceLabel)}</span></div>`
        : '';
    const date = escapeHtml(markerData.date || 'Unknown');
    const latNumber = Number(markerData.lat);
    const lngNumber = Number(markerData.lng);
    const latText = Number.isFinite(latNumber) ? latNumber.toFixed(4) : String(markerData.lat ?? '');
    const lngText = Number.isFinite(lngNumber) ? lngNumber.toFixed(4) : String(markerData.lng ?? '');
    const coordinates = `${escapeHtml(latText)}, ${escapeHtml(lngText)}`;
    const hasId = Boolean(markerId);
    const aliasRow = hasAlias
        ? `<div class="marker-popup-row"><span class="marker-popup-label">Place Name</span><span class="marker-popup-value">${place}</span></div>`
        : '';
    const actions = hasId
        ? `<div class="marker-actions"><button type="button" class="marker-action marker-action-trip">Add to Trip</button><button type="button" class="marker-action marker-action-alias">Rename</button><button type="button" class="marker-action marker-action-archive">Archive</button><button type="button" class="marker-action marker-action-delete">Delete</button></div>`
        : '';

    return [
        `<div class="marker-popup"${hasId ? ` data-marker-id="${safeId}"` : ''}>`,
        `<div class="marker-popup-row"><span class="marker-popup-label">${nameLabel}</span><span class="marker-popup-value">${displayName}</span></div>`,
        aliasRow,
        sourceRow,
        `<div class="marker-popup-row"><span class="marker-popup-label">Date Visited</span><span class="marker-popup-value">${date}</span></div>`,
        `<div class="marker-popup-row"><span class="marker-popup-label">Coordinates</span><span class="marker-popup-value">${coordinates}</span></div>`,
        actions,
        `</div>`,
    ].filter(Boolean).join('');
}

function getSourceTypeLabel(type) {
    if (!type) { return ''; }
    if (Object.prototype.hasOwnProperty.call(SOURCE_TYPE_LABELS, type)) {
        return SOURCE_TYPE_LABELS[type];
    }
    return type
        .replace(/_/g, ' ')
        .replace(/\b\w/g, (letter) => letter.toUpperCase());
}

function getMarkerIcon(sourceType) {
    const iconUrl = MARKER_ICON_PATHS[sourceType] || MARKER_ICON_PATHS.default;
    if (markerIconCache.has(iconUrl)) {
        return markerIconCache.get(iconUrl);
    }
    const icon = L.icon({
        className: 'marker-pin-icon',
        iconUrl,
        iconRetinaUrl: iconUrl,
        iconSize: [36, 48],
        iconAnchor: [18, 44],
        popupAnchor: [0, -40],
    });

    markerIconCache.set(iconUrl, icon);
    return icon;
}

function initTripsPanel() {
    if (tripListState.initialised) { return; }

    tripListContainer = document.getElementById('tripList');
    if (tripListContainer && !tripListContainer.hasAttribute('tabindex')) {
        tripListContainer.tabIndex = -1;
    }
    tripListLoadingElement = document.getElementById('tripListLoading');
    tripListErrorElement = document.getElementById('tripListError');
    tripListEmptyElement = document.getElementById('tripListEmpty');
    tripSearchInput = document.getElementById('tripSearchInput');
    tripSortFieldSelect = document.getElementById('tripSortField');
    tripSortDirectionButton = document.getElementById('tripSortDirection');
    tripListView = document.getElementById('tripListView');

    if (tripSearchInput) {
        tripSearchInput.addEventListener('input', () => {
            tripListState.searchTerm = tripSearchInput.value.trim().toLowerCase();
            renderTripList();
        });
    }

    if (tripSortFieldSelect) {
        tripSortFieldSelect.value = tripListState.sortField;
        tripSortFieldSelect.addEventListener('change', () => {
            const value = tripSortFieldSelect.value === TRIP_SORT_FIELD_UPDATED
                ? TRIP_SORT_FIELD_UPDATED
                : TRIP_SORT_FIELD_NAME;
            tripListState.sortField = value;
            renderTripList();
        });
    }

    if (tripSortDirectionButton) {
        tripSortDirectionButton.addEventListener('click', () => {
            tripListState.sortDirection = tripListState.sortDirection === TRIP_SORT_DIRECTION_ASC
                ? TRIP_SORT_DIRECTION_DESC
                : TRIP_SORT_DIRECTION_ASC;
            updateTripSortDirectionButton();
            renderTripList();
        });
        updateTripSortDirectionButton();
    }

    if (tripListContainer) {
        tripListContainer.addEventListener('click', handleTripListClick);
        tripListContainer.addEventListener('keydown', handleTripListKeydown);
    }

    tripListState.initialised = true;
    initTripDetailPanel();
}

function updateTripSortDirectionButton() {
    if (!tripSortDirectionButton) { return; }
    const isAscending = tripListState.sortDirection !== TRIP_SORT_DIRECTION_DESC;
    tripSortDirectionButton.textContent = isAscending ? 'Ascending' : 'Descending';
    tripSortDirectionButton.setAttribute('aria-label', isAscending ? 'Sort descending' : 'Sort ascending');
    tripSortDirectionButton.title = isAscending ? 'Switch to descending order' : 'Switch to ascending order';
}

function setTripListLoading(isLoading) {
    if (!tripListState.initialised) { initTripsPanel(); }
    if (tripListLoadingElement) {
        tripListLoadingElement.hidden = !isLoading;
    }
    if (!isLoading) { return; }
    if (tripListContainer) { tripListContainer.hidden = true; }
    if (tripListEmptyElement) { tripListEmptyElement.hidden = true; }
    if (tripListErrorElement) { tripListErrorElement.hidden = true; }
}

function clearTripListMessages() {
    if (tripListEmptyElement) { tripListEmptyElement.hidden = true; }
    if (tripListErrorElement) { tripListErrorElement.hidden = true; tripListErrorElement.textContent = ''; }
}

function hideTripListError() {
    if (tripListErrorElement) {
        tripListErrorElement.hidden = true;
        tripListErrorElement.textContent = '';
    }
}

function showTripListError(message) {
    if (!tripListState.initialised) { initTripsPanel(); }
    if (tripListLoadingElement) { tripListLoadingElement.hidden = true; }
    if (tripListErrorElement) {
        tripListErrorElement.textContent = message || 'Failed to load trips.';
        tripListErrorElement.hidden = false;
    }
    if (tripListContainer) { tripListContainer.hidden = true; }
    if (tripListEmptyElement) { tripListEmptyElement.hidden = true; }
}

function showTripListEmpty(message) {
    if (!tripListState.initialised) { initTripsPanel(); }
    if (tripListLoadingElement) { tripListLoadingElement.hidden = true; }
    if (tripListEmptyElement) {
        if (message) { tripListEmptyElement.textContent = message; }
        tripListEmptyElement.hidden = false;
    }
    if (tripListContainer) { tripListContainer.hidden = true; }
}

function normaliseTripList(trips) {
    if (!Array.isArray(trips)) { return []; }
    return trips.map((trip) => normaliseTrip(trip)).filter(Boolean);
}

function normaliseTrip(trip) {
    if (!trip || typeof trip !== 'object') { return null; }

    const identifierRaw = trip.id ?? trip.trip_id ?? '';
    const identifier = typeof identifierRaw === 'string'
        ? identifierRaw.trim()
        : String(identifierRaw || '').trim();
    if (!identifier) { return null; }

    const nameRaw = trip.name ?? '';
    const name = typeof nameRaw === 'string'
        ? (nameRaw.trim() || TRIP_NAME_FALLBACK)
        : (String(nameRaw || '').trim() || TRIP_NAME_FALLBACK);

    const locationRaw = trip.location_count ?? (Array.isArray(trip.place_ids) ? trip.place_ids.length : 0);
    const locationNumber = Number(locationRaw);
    const locationCount = Number.isFinite(locationNumber) && locationNumber >= 0
        ? locationNumber
        : 0;

    const createdAtRaw = trip.created_at ?? '';
    const createdAt = typeof createdAtRaw === 'string'
        ? createdAtRaw
        : (createdAtRaw ? String(createdAtRaw) : '');

    const updatedAtRaw = trip.updated_at ?? '';
    const updatedAt = typeof updatedAtRaw === 'string'
        ? updatedAtRaw
        : (updatedAtRaw ? String(updatedAtRaw) : '');

    return {
        id: identifier,
        name,
        location_count: locationCount,
        created_at: createdAt,
        updated_at: updatedAt,
    };
}

function updateTripsPanel(trips) {
    if (!tripListState.initialised) { initTripsPanel(); }
    const normalisedTrips = normaliseTripList(trips);
    tripListState.trips = normalisedTrips;
    hideTripListError();

    const selectedId = tripDetailState.selectedTripId;
    if (selectedId) {
        const selectedTrip = normalisedTrips.find((entry) => entry.id === selectedId);
        if (!selectedTrip) {
            tripLocationCache.delete(selectedId);
            closeTripDetail({ restoreFocus: false, skipRender: true });
        } else if (tripDetailState.trip) {
            tripDetailState.trip = { ...tripDetailState.trip, ...selectedTrip };
            updateTripDetailHeader();
        }
    }

    renderTripList();
}

function renderTripList() {
    if (!tripListState.initialised) { initTripsPanel(); }
    if (!tripListContainer) { return; }

    const trips = Array.isArray(tripListState.trips) ? tripListState.trips : [];
    const hasTrips = trips.length > 0;
    const searchTerm = tripListState.searchTerm;

    let filteredTrips = trips;
    if (searchTerm) {
        filteredTrips = trips.filter((trip) => createTripSearchText(trip).includes(searchTerm));
    }

    tripListContainer.innerHTML = '';

    if (!hasTrips) {
        showTripListEmpty('No trips yet. Assign a location to begin your first journey.');
        return;
    }

    if (!filteredTrips.length) {
        showTripListEmpty('No trips match your search.');
        return;
    }

    clearTripListMessages();
    if (tripListLoadingElement) { tripListLoadingElement.hidden = true; }

    const sortedTrips = filteredTrips.slice().sort((a, b) => compareTrips(a, b));
    const fragment = document.createDocumentFragment();
    sortedTrips.forEach((trip) => {
        const item = createTripListItem(trip);
        if (item) { fragment.appendChild(item); }
    });

    tripListContainer.appendChild(fragment);
    tripListContainer.hidden = false;
    tripListContainer.scrollTop = 0;
}

function compareTrips(a, b) {
    const direction = tripListState.sortDirection === TRIP_SORT_DIRECTION_DESC ? -1 : 1;
    const field = tripListState.sortField === TRIP_SORT_FIELD_UPDATED
        ? TRIP_SORT_FIELD_UPDATED
        : TRIP_SORT_FIELD_NAME;

    if (field === TRIP_SORT_FIELD_NAME) {
        const nameA = (a && typeof a.name === 'string') ? a.name : '';
        const nameB = (b && typeof b.name === 'string') ? b.name : '';
        const comparison = nameA.localeCompare(nameB, undefined, { sensitivity: 'base' });
        if (comparison !== 0) { return comparison * direction; }
        const dateDifference = getTripDateValue(a) - getTripDateValue(b);
        if (dateDifference !== 0) { return dateDifference * direction; }
        return 0;
    }

    const dateDifference = getTripDateValue(a) - getTripDateValue(b);
    if (dateDifference !== 0) { return dateDifference * direction; }

    const nameA = (a && typeof a.name === 'string') ? a.name : '';
    const nameB = (b && typeof b.name === 'string') ? b.name : '';
    return nameA.localeCompare(nameB, undefined, { sensitivity: 'base' }) * direction;
}

function getTripDateValue(trip) {
    if (!trip || typeof trip !== 'object') { return 0; }
    const raw = trip.updated_at || trip.created_at || '';
    if (!raw) { return 0; }
    const timestamp = Date.parse(raw);
    return Number.isNaN(timestamp) ? 0 : timestamp;
}

function formatTripLocationCount(value) {
    const count = Number(value);
    if (!Number.isFinite(count) || count < 0) { return '0 locations'; }
    return count === 1 ? '1 location' : `${count} locations`;
}

function formatTripDate(value) {
    if (!value) { return ''; }
    const date = new Date(value);
    if (Number.isNaN(date.getTime())) { return ''; }
    if (tripDateFormatter) { return tripDateFormatter.format(date); }
    return date.toISOString().split('T')[0];
}

function createTripListItem(trip) {
    if (!trip || typeof trip !== 'object') { return null; }

    const item = document.createElement('article');
    item.className = 'trip-item';
    item.setAttribute('role', 'listitem');
    item.dataset.tripId = trip.id;
    item.tabIndex = 0;

    const isSelected = tripDetailState.selectedTripId === trip.id;
    item.setAttribute('aria-selected', isSelected ? 'true' : 'false');
    if (isSelected) {
        item.classList.add('trip-item-active');
        item.setAttribute('aria-current', 'true');
    } else {
        item.setAttribute('aria-current', 'false');
    }

    const title = document.createElement('div');
    title.className = 'trip-item-name';
    title.textContent = trip.name || TRIP_NAME_FALLBACK;
    item.appendChild(title);

    const meta = document.createElement('div');
    meta.className = 'trip-item-meta';

    const dateValue = trip.updated_at || trip.created_at || '';
    const dateLabel = formatTripDate(dateValue);
    if (dateLabel) {
        const dateSpan = document.createElement('span');
        dateSpan.className = 'trip-item-meta-entry';
        dateSpan.append('Updated ');
        const timeElement = document.createElement('time');
        timeElement.dateTime = dateValue;
        timeElement.textContent = dateLabel;
        try {
            const dateObj = new Date(dateValue);
            if (!Number.isNaN(dateObj.getTime())) {
                timeElement.title = dateObj.toLocaleString();
            }
        } catch (error) {
            // Ignore formatting errors
        }
        dateSpan.appendChild(timeElement);
        meta.appendChild(dateSpan);
    }

    const countSpan = document.createElement('span');
    countSpan.className = 'trip-item-meta-entry';
    countSpan.textContent = formatTripLocationCount(trip.location_count);
    meta.appendChild(countSpan);

    item.appendChild(meta);
    return item;
}

function createTripSearchText(trip) {
    if (!trip || typeof trip !== 'object') { return ''; }
    const parts = [];
    if (trip.name) { parts.push(String(trip.name)); }
    if (Number.isFinite(Number(trip.location_count))) { parts.push(String(trip.location_count)); }
    if (trip.updated_at) { parts.push(String(trip.updated_at)); }
    if (trip.created_at) { parts.push(String(trip.created_at)); }
    const formatted = formatTripDate(trip.updated_at || trip.created_at || '');
    if (formatted) { parts.push(formatted); }
    return parts.join(' ').toLowerCase();
}

function initTripDetailPanel() {
    if (tripDetailState.initialised) { return; }

    tripDetailContainer = document.getElementById('tripDetailView');
    tripDetailBackButton = document.getElementById('tripDetailBack');
    tripDetailTitleElement = document.getElementById('tripDetailTitle');
    tripDetailSubtitleElement = document.getElementById('tripDetailSubtitle');
    tripDetailCountElement = document.getElementById('tripDetailCount');
    tripDetailUpdatedElement = document.getElementById('tripDetailUpdated');
    tripLocationSearchInput = document.getElementById('tripLocationSearchInput');
    tripLocationSortFieldSelect = document.getElementById('tripLocationSortField');
    tripLocationSortDirectionButton = document.getElementById('tripLocationSortDirection');
    tripLocationListContainer = document.getElementById('tripLocationList');
    tripLocationLoadingElement = document.getElementById('tripLocationLoading');
    tripLocationErrorElement = document.getElementById('tripLocationError');
    tripLocationEmptyElement = document.getElementById('tripLocationEmpty');

    if (tripDetailTitleElement && !tripDetailTitleElement.dataset.defaultText) {
        tripDetailTitleElement.dataset.defaultText = tripDetailTitleElement.textContent || '';
    }
    if (tripDetailSubtitleElement && !tripDetailSubtitleElement.dataset.defaultText) {
        tripDetailSubtitleElement.dataset.defaultText = tripDetailSubtitleElement.textContent || '';
    }

    if (tripDetailBackButton) {
        tripDetailBackButton.addEventListener('click', (event) => {
            if (event) { event.preventDefault(); }
            closeTripDetail();
        });
    }

    if (tripLocationSearchInput) {
        tripLocationSearchInput.addEventListener('input', () => {
            tripDetailState.searchTerm = tripLocationSearchInput.value.trim().toLowerCase();
            renderTripLocationList();
        });
    }

    if (tripLocationSortFieldSelect) {
        tripLocationSortFieldSelect.value = tripDetailState.sortField;
        tripLocationSortFieldSelect.addEventListener('change', () => {
            const value = tripLocationSortFieldSelect.value === TRIP_LOCATION_SORT_FIELD_NAME
                ? TRIP_LOCATION_SORT_FIELD_NAME
                : TRIP_LOCATION_SORT_FIELD_DATE;
            tripDetailState.sortField = value;
            renderTripLocationList();
        });
    }

    if (tripLocationSortDirectionButton) {
        tripLocationSortDirectionButton.addEventListener('click', () => {
            tripDetailState.sortDirection = tripDetailState.sortDirection === TRIP_SORT_DIRECTION_ASC
                ? TRIP_SORT_DIRECTION_DESC
                : TRIP_SORT_DIRECTION_ASC;
            updateTripLocationSortDirectionButton();
            renderTripLocationList();
        });
        updateTripLocationSortDirectionButton();
    }

    tripDetailState.initialised = true;
}

function handleTripListClick(event) {
    if (!tripListContainer) { return; }
    const target = event.target ? event.target.closest('.trip-item') : null;
    if (!target || !tripListContainer.contains(target)) { return; }
    const tripId = target.dataset.tripId || '';
    if (!tripId) { return; }
    event.preventDefault();
    openTripDetail(tripId, target);
}

function handleTripListKeydown(event) {
    if (!tripListContainer) { return; }
    if (event.defaultPrevented) { return; }
    const key = event.key;
    if (key !== 'Enter' && key !== ' ') { return; }
    const target = event.target ? (event.target.classList && event.target.classList.contains('trip-item')
        ? event.target
        : event.target.closest('.trip-item')) : null;
    if (!target || !tripListContainer.contains(target)) { return; }
    const tripId = target.dataset.tripId || '';
    if (!tripId) { return; }
    event.preventDefault();
    openTripDetail(tripId, target);
}

function openTripDetail(tripId, triggerElement) {
    if (!tripId) { return; }
    if (!tripListState.initialised) { initTripsPanel(); }
    initTripDetailPanel();

    const requestId = tripDetailState.requestId + 1;
    tripDetailState.requestId = requestId;
    tripDetailState.selectedTripId = tripId;
    tripDetailState.triggerElement = triggerElement || null;
    tripDetailState.searchTerm = '';
    tripDetailState.sortField = TRIP_LOCATION_SORT_FIELD_DATE;
    tripDetailState.sortDirection = TRIP_SORT_DIRECTION_ASC;
    tripDetailState.locations = [];
    tripDetailState.trip = null;

    if (tripLocationSearchInput) { tripLocationSearchInput.value = ''; }
    if (tripLocationSortFieldSelect) { tripLocationSortFieldSelect.value = TRIP_LOCATION_SORT_FIELD_DATE; }
    updateTripLocationSortDirectionButton();
    clearTripLocationMessages();
    if (tripLocationListContainer) {
        tripLocationListContainer.innerHTML = '';
        tripLocationListContainer.hidden = true;
    }
    hideTripLocationError();

    const fallbackTrip = Array.isArray(tripListState.trips)
        ? tripListState.trips.find((entry) => entry.id === tripId)
        : null;
    if (fallbackTrip) {
        tripDetailState.trip = { ...fallbackTrip };
    }
    updateTripDetailHeader();

    showTripDetailView();
    renderTripList();
    setTripDetailLoading(true);

    const cached = tripLocationCache.get(tripId);
    if (cached && Array.isArray(cached.locations)) {
        const normalisedTrip = normaliseTrip(cached.trip) || fallbackTrip || { id: tripId, name: TRIP_NAME_FALLBACK };
        const locations = normaliseTripLocationList(cached.locations);
        tripDetailState.trip = { ...normalisedTrip, location_count: locations.length };
        tripDetailState.locations = locations;
        updateTripDetailHeader();
        renderTripLocationList();
        setTripDetailLoading(false);
    } else {
        loadTripDetailData(tripId, requestId);
    }

    if (tripLocationSearchInput) {
        try {
            tripLocationSearchInput.focus({ preventScroll: true });
        } catch (error) {
            tripLocationSearchInput.focus();
        }
    }
}

function closeTripDetail(options = {}) {
    initTripDetailPanel();
    const { restoreFocus = true, skipRender = false } = options || {};
    const previousTripId = tripDetailState.selectedTripId;
    const triggerElement = tripDetailState.triggerElement;

    tripDetailState.selectedTripId = null;
    tripDetailState.trip = null;
    tripDetailState.locations = [];
    tripDetailState.searchTerm = '';
    tripDetailState.sortField = TRIP_LOCATION_SORT_FIELD_DATE;
    tripDetailState.sortDirection = TRIP_SORT_DIRECTION_ASC;
    tripDetailState.requestId += 1;
    tripDetailState.triggerElement = null;

    if (tripLocationSearchInput) { tripLocationSearchInput.value = ''; }
    if (tripLocationSortFieldSelect) { tripLocationSortFieldSelect.value = TRIP_LOCATION_SORT_FIELD_DATE; }
    updateTripLocationSortDirectionButton();
    clearTripLocationMessages();
    hideTripLocationError();
    if (tripLocationListContainer) {
        tripLocationListContainer.innerHTML = '';
        tripLocationListContainer.hidden = true;
    }
    setTripDetailLoading(false);
    hideTripDetailView();

    if (tripDetailTitleElement) {
        const defaultTitle = tripDetailTitleElement.dataset.defaultText || 'Trip details';
        tripDetailTitleElement.textContent = defaultTitle;
    }
    if (tripDetailSubtitleElement) {
        const defaultSubtitle = tripDetailSubtitleElement.dataset.defaultText || 'Review the places assigned to this journey.';
        tripDetailSubtitleElement.textContent = defaultSubtitle;
    }
    if (tripDetailCountElement) { tripDetailCountElement.textContent = ''; }
    if (tripDetailUpdatedElement) {
        tripDetailUpdatedElement.hidden = true;
        tripDetailUpdatedElement.textContent = '';
    }

    if (!skipRender) {
        renderTripList();
    }

    if (restoreFocus) {
        let focusTarget = null;
        if (triggerElement && document.body.contains(triggerElement)) {
            focusTarget = triggerElement;
        } else if (tripListContainer) {
            const items = Array.from(tripListContainer.querySelectorAll('.trip-item'));
            if (previousTripId) {
                focusTarget = items.find((element) => element.dataset.tripId === previousTripId) || null;
            }
            if (!focusTarget) {
                focusTarget = items[0] || tripListContainer;
            }
        }

        if (focusTarget && typeof focusTarget.focus === 'function') {
            try {
                focusTarget.focus({ preventScroll: true });
            } catch (error) {
                focusTarget.focus();
            }
        }
    }
}

function showTripDetailView() {
    initTripDetailPanel();
    if (tripListView) {
        tripListView.hidden = true;
        tripListView.setAttribute('aria-hidden', 'true');
    }
    if (tripDetailContainer) {
        tripDetailContainer.hidden = false;
        tripDetailContainer.setAttribute('aria-hidden', 'false');
    }
}

function hideTripDetailView() {
    initTripDetailPanel();
    if (tripDetailContainer) {
        tripDetailContainer.hidden = true;
        tripDetailContainer.setAttribute('aria-hidden', 'true');
    }
    if (tripListView) {
        tripListView.hidden = false;
        tripListView.setAttribute('aria-hidden', 'false');
    }
}

function updateTripDetailHeader() {
    initTripDetailPanel();
    const trip = tripDetailState.trip;
    if (tripDetailTitleElement) {
        const defaultTitle = tripDetailTitleElement.dataset.defaultText || 'Trip details';
        const name = trip && trip.name ? trip.name : defaultTitle;
        tripDetailTitleElement.textContent = name;
    }
    if (tripDetailSubtitleElement) {
        const defaultSubtitle = tripDetailSubtitleElement.dataset.defaultText || 'Review the places assigned to this journey.';
        tripDetailSubtitleElement.textContent = defaultSubtitle;
    }
    if (tripDetailCountElement) {
        const count = Array.isArray(tripDetailState.locations) ? tripDetailState.locations.length : 0;
        tripDetailCountElement.textContent = formatTripLocationCount(count);
    }
    if (tripDetailUpdatedElement) {
        const updatedValue = trip && (trip.updated_at || trip.created_at || '');
        const formatted = formatTripDate(updatedValue);
        if (formatted) {
            tripDetailUpdatedElement.hidden = false;
            tripDetailUpdatedElement.textContent = '';
            tripDetailUpdatedElement.append('Updated ');
            const timeElement = document.createElement('time');
            timeElement.dateTime = updatedValue;
            timeElement.textContent = formatted;
            try {
                const dateObj = new Date(updatedValue);
                if (!Number.isNaN(dateObj.getTime())) {
                    timeElement.title = dateObj.toLocaleString();
                }
            } catch (error) {
                // Ignore formatting issues
            }
            tripDetailUpdatedElement.appendChild(timeElement);
        } else {
            tripDetailUpdatedElement.hidden = true;
            tripDetailUpdatedElement.textContent = '';
        }
    }
}

function updateTripLocationSortDirectionButton() {
    if (!tripLocationSortDirectionButton) { return; }
    const isAscending = tripDetailState.sortDirection !== TRIP_SORT_DIRECTION_DESC;
    tripLocationSortDirectionButton.textContent = isAscending ? 'Ascending' : 'Descending';
    tripLocationSortDirectionButton.setAttribute('aria-label', isAscending ? 'Sort descending' : 'Sort ascending');
    tripLocationSortDirectionButton.title = isAscending ? 'Switch to descending order' : 'Switch to ascending order';
}

function setTripDetailLoading(isLoading) {
    if (!tripDetailState.initialised) { initTripDetailPanel(); }
    if (tripLocationLoadingElement) {
        tripLocationLoadingElement.hidden = !isLoading;
    }
    if (!isLoading) { return; }
    if (tripLocationListContainer) { tripLocationListContainer.hidden = true; }
    if (tripLocationEmptyElement) { tripLocationEmptyElement.hidden = true; }
    if (tripLocationErrorElement) {
        tripLocationErrorElement.hidden = true;
        tripLocationErrorElement.textContent = '';
    }
}

function clearTripLocationMessages() {
    if (tripLocationEmptyElement) { tripLocationEmptyElement.hidden = true; }
    if (tripLocationErrorElement) {
        tripLocationErrorElement.hidden = true;
        tripLocationErrorElement.textContent = '';
    }
}

function hideTripLocationError() {
    if (tripLocationErrorElement) {
        tripLocationErrorElement.hidden = true;
        tripLocationErrorElement.textContent = '';
    }
}

function showTripLocationError(message) {
    if (!tripDetailState.initialised) { initTripDetailPanel(); }
    if (tripLocationLoadingElement) { tripLocationLoadingElement.hidden = true; }
    if (tripLocationErrorElement) {
        tripLocationErrorElement.textContent = message || 'Failed to load locations.';
        tripLocationErrorElement.hidden = false;
    }
    if (tripLocationListContainer) { tripLocationListContainer.hidden = true; }
    if (tripLocationEmptyElement) { tripLocationEmptyElement.hidden = true; }
}

function showTripLocationEmpty(message) {
    if (!tripDetailState.initialised) { initTripDetailPanel(); }
    if (tripLocationLoadingElement) { tripLocationLoadingElement.hidden = true; }
    if (tripLocationEmptyElement) {
        if (message) { tripLocationEmptyElement.textContent = message; }
        tripLocationEmptyElement.hidden = false;
    }
    if (tripLocationListContainer) { tripLocationListContainer.hidden = true; }
    if (tripLocationErrorElement) {
        tripLocationErrorElement.hidden = true;
        tripLocationErrorElement.textContent = '';
    }
}

function renderTripLocationList() {
    if (!tripDetailState.initialised) { initTripDetailPanel(); }
    if (!tripLocationListContainer) { return; }

    const locations = Array.isArray(tripDetailState.locations) ? tripDetailState.locations : [];
    const hasLocations = locations.length > 0;
    const searchTerm = tripDetailState.searchTerm;

    let filtered = locations;
    if (searchTerm) {
        filtered = locations.filter((location) => createTripLocationSearchText(location).includes(searchTerm));
    }

    tripLocationListContainer.innerHTML = '';

    if (!hasLocations) {
        showTripLocationEmpty('No locations assigned to this trip yet.');
        return;
    }

    if (!filtered.length) {
        showTripLocationEmpty('No locations match your search.');
        return;
    }

    clearTripLocationMessages();
    if (tripLocationLoadingElement) { tripLocationLoadingElement.hidden = true; }

    const sorted = filtered.slice().sort((a, b) => compareTripLocations(a, b));
    const fragment = document.createDocumentFragment();
    sorted.forEach((location) => {
        const element = createTripLocationListItem(location);
        if (element) { fragment.appendChild(element); }
    });

    tripLocationListContainer.appendChild(fragment);
    tripLocationListContainer.hidden = false;
    tripLocationListContainer.scrollTop = 0;
}

function compareTripLocations(a, b) {
    const direction = tripDetailState.sortDirection === TRIP_SORT_DIRECTION_DESC ? -1 : 1;
    const field = tripDetailState.sortField === TRIP_LOCATION_SORT_FIELD_NAME
        ? TRIP_LOCATION_SORT_FIELD_NAME
        : TRIP_LOCATION_SORT_FIELD_DATE;

    if (field === TRIP_LOCATION_SORT_FIELD_NAME) {
        const nameA = (a && typeof a.display_name === 'string') ? a.display_name : '';
        const nameB = (b && typeof b.display_name === 'string') ? b.display_name : '';
        const comparison = nameA.localeCompare(nameB, undefined, { sensitivity: 'base' });
        if (comparison !== 0) { return comparison * direction; }
    } else {
        const valueA = (a && typeof a.date_value === 'number' && Number.isFinite(a.date_value))
            ? a.date_value
            : (direction === 1 ? Number.MAX_SAFE_INTEGER : Number.MIN_SAFE_INTEGER);
        const valueB = (b && typeof b.date_value === 'number' && Number.isFinite(b.date_value))
            ? b.date_value
            : (direction === 1 ? Number.MAX_SAFE_INTEGER : Number.MIN_SAFE_INTEGER);
        if (valueA !== valueB) {
            return (valueA - valueB) * direction;
        }
    }

    const secondaryA = (a && typeof a.display_name === 'string') ? a.display_name : '';
    const secondaryB = (b && typeof b.display_name === 'string') ? b.display_name : '';
    const secondaryComparison = secondaryA.localeCompare(secondaryB, undefined, { sensitivity: 'base' });
    if (secondaryComparison !== 0) { return secondaryComparison * direction; }

    const orderA = (a && typeof a.order === 'number' && Number.isFinite(a.order)) ? a.order : 0;
    const orderB = (b && typeof b.order === 'number' && Number.isFinite(b.order)) ? b.order : 0;
    return (orderA - orderB) * direction;
}

function normaliseTripLocationList(locations) {
    if (!Array.isArray(locations)) { return []; }
    return locations.map((location, index) => normaliseTripLocation(location, index)).filter(Boolean);
}

function normaliseTripLocation(location, index) {
    if (!location || typeof location !== 'object') { return null; }

    const rawId = location.place_id ?? location.id ?? '';
    const placeId = typeof rawId === 'string' ? rawId.trim() : String(rawId || '').trim();

    const nameRaw = location.name ?? '';
    const name = typeof nameRaw === 'string' ? nameRaw.trim() : String(nameRaw || '').trim();

    const aliasRaw = location.alias ?? '';
    const alias = typeof aliasRaw === 'string' ? aliasRaw.trim() : String(aliasRaw || '').trim();

    const displayRaw = location.display_name ?? '';
    let displayName = typeof displayRaw === 'string' ? displayRaw.trim() : String(displayRaw || '').trim();
    if (!displayName) {
        displayName = alias || name || 'Unknown location';
    }

    const startDateRaw = location.start_date ?? '';
    const startDate = typeof startDateRaw === 'string' ? startDateRaw.trim() : String(startDateRaw || '').trim();

    const endDateRaw = location.end_date ?? '';
    const endDate = typeof endDateRaw === 'string' ? endDateRaw.trim() : String(endDateRaw || '').trim();

    const dateRaw = location.date ?? '';
    const dateValue = typeof dateRaw === 'string' ? dateRaw.trim() : String(dateRaw || '').trim();
    const primaryDate = dateValue || startDate || endDate;

    let timestamp = null;
    if (primaryDate) {
        const parsed = Date.parse(primaryDate);
        if (!Number.isNaN(parsed)) {
            timestamp = parsed;
        }
    }

    const sourceTypeRaw = location.source_type ?? '';
    const sourceType = typeof sourceTypeRaw === 'string' ? sourceTypeRaw.trim() : String(sourceTypeRaw || '').trim();

    const archived = Boolean(location.archived);
    const missing = Boolean(location.missing);
    const orderValue = Number(location.order);
    const order = Number.isFinite(orderValue) ? orderValue : index;

    const latitudeNumber = Number(location.latitude);
    const longitudeNumber = Number(location.longitude);
    const latitude = Number.isFinite(latitudeNumber) ? latitudeNumber : null;
    const longitude = Number.isFinite(longitudeNumber) ? longitudeNumber : null;

    return {
        place_id: placeId,
        name,
        alias,
        display_name: displayName,
        start_date: startDate,
        end_date: endDate,
        date: primaryDate,
        date_value: timestamp,
        source_type: sourceType,
        archived,
        missing,
        order,
        latitude,
        longitude,
    };
}

function createTripLocationSearchText(location) {
    if (!location || typeof location !== 'object') { return ''; }
    const parts = [];
    if (location.display_name) { parts.push(String(location.display_name)); }
    if (location.alias) { parts.push(String(location.alias)); }
    if (location.name) { parts.push(String(location.name)); }
    if (location.place_id) { parts.push(String(location.place_id)); }
    if (location.source_type) { parts.push(getSourceTypeLabel(location.source_type)); }
    if (location.date) { parts.push(String(location.date)); }
    if (location.start_date) { parts.push(String(location.start_date)); }
    if (location.end_date) { parts.push(String(location.end_date)); }
    const formatted = formatTripDate(location.date || location.start_date || location.end_date || '');
    if (formatted) { parts.push(formatted); }
    return parts.join(' ').toLowerCase();
}

function createTripLocationListItem(location) {
    if (!location || typeof location !== 'object') { return null; }

    const item = document.createElement('article');
    item.className = 'trip-location-item';
    item.setAttribute('role', 'listitem');
    if (location.place_id) { item.dataset.placeId = location.place_id; }
    if (location.missing) {
        item.classList.add('trip-location-item-missing');
    }

    const title = document.createElement('div');
    title.className = 'trip-location-name';
    title.textContent = location.display_name || 'Unknown location';
    item.appendChild(title);

    const meta = document.createElement('div');
    meta.className = 'trip-location-meta';

    if (location.missing) {
        const missingNote = document.createElement('div');
        missingNote.className = 'trip-location-missing-note';
        missingNote.textContent = 'Details for this location are unavailable in the current timeline.';
        meta.appendChild(missingNote);
    } else {
        if (location.alias && location.name && location.alias !== location.name) {
            const originalRow = document.createElement('div');
            originalRow.className = 'trip-location-meta-entry';
            originalRow.append('Place: ');
            const originalName = document.createElement('span');
            originalName.textContent = location.name;
            originalRow.appendChild(originalName);
            meta.appendChild(originalRow);
        } else if (location.name && (!location.display_name || location.display_name !== location.name)) {
            const nameRow = document.createElement('div');
            nameRow.className = 'trip-location-meta-entry';
            nameRow.append('Place: ');
            const nameValue = document.createElement('span');
            nameValue.textContent = location.name;
            nameRow.appendChild(nameValue);
            meta.appendChild(nameRow);
        }

        const metaRow = document.createElement('div');
        metaRow.className = 'trip-location-meta-row';

        const dateLabel = location.date || location.start_date || location.end_date || '';
        const formattedDate = formatTripDate(dateLabel);
        if (formattedDate) {
            const dateEntry = document.createElement('span');
            dateEntry.className = 'trip-location-meta-entry';
            dateEntry.append('Visited ');
            const timeElement = document.createElement('time');
            timeElement.dateTime = dateLabel;
            timeElement.textContent = formattedDate;
            try {
                const dateObj = new Date(dateLabel);
                if (!Number.isNaN(dateObj.getTime())) {
                    timeElement.title = dateObj.toLocaleString();
                }
            } catch (error) {
                // Ignore formatting errors
            }
            dateEntry.appendChild(timeElement);
            metaRow.appendChild(dateEntry);
        }

        if (location.source_type) {
            const sourceEntry = document.createElement('span');
            sourceEntry.className = 'trip-location-meta-entry';
            const label = document.createElement('span');
            label.className = 'trip-location-meta-label';
            label.textContent = 'Source';
            const value = document.createElement('span');
            value.textContent = getSourceTypeLabel(location.source_type);
            sourceEntry.appendChild(label);
            sourceEntry.appendChild(value);
            metaRow.appendChild(sourceEntry);
        }

        if (location.archived) {
            const archivedTag = document.createElement('span');
            archivedTag.className = 'trip-location-tag';
            archivedTag.textContent = 'Archived';
            metaRow.appendChild(archivedTag);
        }

        if (metaRow.children.length) {
            meta.appendChild(metaRow);
        }
    }

    item.appendChild(meta);
    return item;
}

async function loadTripDetailData(tripId, requestId) {
    if (!tripId) { return; }
    initTripDetailPanel();

    const activeRequestId = typeof requestId === 'number' ? requestId : tripDetailState.requestId + 1;
    if (typeof requestId !== 'number') {
        tripDetailState.requestId = activeRequestId;
    }

    try {
        const response = await fetch(`/api/trips/${encodeURIComponent(tripId)}`);
        if (!response.ok) {
            throw new Error('Failed to load trip.');
        }
        const data = await response.json();
        if (tripDetailState.requestId !== activeRequestId || tripDetailState.selectedTripId !== tripId) { return; }

        const tripData = data && typeof data === 'object' && !Array.isArray(data)
            ? (data.trip ?? data)
            : {};
        const locationsRaw = data && typeof data === 'object' && Array.isArray(data.locations)
            ? data.locations
            : [];

        tripLocationCache.set(tripId, { trip: tripData, locations: locationsRaw });

        const normalisedTrip = normaliseTrip(tripData) || { id: tripId, name: TRIP_NAME_FALLBACK };
        const locations = normaliseTripLocationList(locationsRaw);

        tripDetailState.trip = { ...normalisedTrip, location_count: locations.length };
        tripDetailState.locations = locations;
        updateTripDetailHeader();
        renderTripLocationList();
    } catch (error) {
        if (tripDetailState.requestId !== activeRequestId || tripDetailState.selectedTripId !== tripId) { return; }
        console.error('Failed to load trip details', error);
        showTripLocationError(error.message || 'Failed to load trip.');
    } finally {
        if (tripDetailState.requestId === activeRequestId && tripDetailState.selectedTripId === tripId) {
            setTripDetailLoading(false);
        }
    }
}

async function loadTripsPanelData() {
    if (!tripListState.initialised) { initTripsPanel(); }
    setTripListLoading(true);
    hideTripListError();
    try {
        const response = await fetch('/api/trips');
        if (!response.ok) {
            throw new Error('Failed to load trips.');
        }
        const data = await response.json();
        updateTripsPanel(Array.isArray(data) ? data : []);
    } catch (error) {
        console.error('Failed to load trips', error);
        showTripListError(error.message || 'Failed to load trips.');
    } finally {
        setTripListLoading(false);
    }
}

function upsertTripInList(trip) {
    const normalised = normaliseTrip(trip);
    if (!normalised) { return; }

    const existing = Array.isArray(tripListState.trips) ? [...tripListState.trips] : [];
    const index = existing.findIndex((entry) => entry.id === normalised.id);

    if (index === -1) {
        existing.push(normalised);
    } else {
        existing[index] = { ...existing[index], ...normalised };
    }

    tripListState.trips = existing;
    tripLocationCache.delete(normalised.id);
    if (tripDetailState.selectedTripId === normalised.id) {
        tripDetailState.trip = { ...normalised };
        updateTripDetailHeader();
        const requestId = tripDetailState.requestId + 1;
        tripDetailState.requestId = requestId;
        setTripDetailLoading(true);
        loadTripDetailData(normalised.id, requestId);
    }
    renderTripList();
}

function showLoading() { document.getElementById('loading').style.display = 'flex'; }
function hideLoading() { document.getElementById('loading').style.display = 'none'; }
function showStatus(message, isError=false) {
    const status = document.getElementById('status');
    status.textContent = message;
    status.className = isError ? 'error' : 'success';
    status.style.display = 'block';
    setTimeout(() => status.style.display = 'none', 4000);
}

function initMap() {
    // Create a Leaflet map centered on a default view
    map = L.map('map').setView([40.65997395108914, -73.71300111746832], 5);
    // Add Mapbox tiles using the token passed from the backend
    L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/outdoors-v12/tiles/{z}/{x}/{y}?access_token=${MAPBOX_TOKEN}`, {
        maxZoom: 18,
        attribution: 'Mapbox'
    }).addTo(map);
    // Cluster group keeps the map responsive when many markers are shown
    markerCluster = L.markerClusterGroup();
    map.addLayer(markerCluster);
    // Load existing markers once the map is ready
    loadMarkers();
}

async function loadMarkers() {
    // Show a loading overlay while fetching marker data
    showLoading();
    const startDateInput = document.getElementById('filterStartDate');
    const endDateInput = document.getElementById('filterEndDate');
    const startDate = startDateInput ? startDateInput.value : '';
    const endDate = endDateInput ? endDateInput.value : '';

    if (startDate && endDate && startDate > endDate) {
        hideLoading();
        showStatus('Start date must be on or before end date.', true);
        return;
    }

    // Remove any markers currently displayed
    markerCluster.clearLayers();
    // Collect the values of all checked source type filters
    const checked = Array.from(
        document.querySelectorAll('#sourceTypeFilters input:checked')
    ).map(cb => cb.value);

    const payload = { source_types: checked };
    if (startDate) { payload.start_date = startDate; }
    if (endDate) { payload.end_date = endDate; }

    try {
        // Request the marker list from the server, filtering by source type
        const response = await fetch('/api/map_data', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        // Parse the JSON response
        const markers = await response.json();
        // Add a Leaflet marker for each item returned
        markers.forEach(m => {
            const lat = Number(m.lat);
            const lng = Number(m.lng);
            if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
                return;
            }

            const displayNameRaw = m.display_name ?? '';
            const displayNameClean = typeof displayNameRaw === 'string'
                ? displayNameRaw.trim()
                : String(displayNameRaw || '').trim();
            const placeRaw = m.place ?? '';
            const placeClean = typeof placeRaw === 'string'
                ? placeRaw.trim()
                : String(placeRaw || '').trim();
            const markerTitle = displayNameClean || placeClean;

            const marker = L.marker([lat, lng], {
                icon: getMarkerIcon(m.source_type),
                title: markerTitle,
                riseOnHover: true,
            });

            const popupContent = createPopupContent(m);
            marker.bindPopup(popupContent).addTo(markerCluster);

            marker.on('popupopen', () => {
                const popupElement = marker.getPopup() ? marker.getPopup().getElement() : null;
                if (!popupElement) { return; }

                const tripButton = popupElement.querySelector('.marker-action-trip');
                if (tripButton) {
                    tripButton.onclick = (event) => {
                        event.preventDefault();
                        openTripAssignmentModal(m, { triggerButton: tripButton });
                    };
                }

                const archiveButton = popupElement.querySelector('.marker-action-archive');
                if (archiveButton) {
                    archiveButton.onclick = (event) => {
                        event.preventDefault();
                        archiveMarker(m.id, marker, archiveButton);
                    };
                }

                const renameButton = popupElement.querySelector('.marker-action-alias');
                if (renameButton) {
                    renameButton.onclick = (event) => {
                        event.preventDefault();
                        openAliasModal(m, { triggerButton: renameButton, isArchived: false });
                    };
                }

                const deleteButton = popupElement.querySelector('.marker-action-delete');
                if (deleteButton) {
                    deleteButton.onclick = (event) => {
                        event.preventDefault();
                        deleteMarker(m.id, marker, deleteButton);
                    };
                }
            });
        });
        // Done loading
        hideLoading();
    } catch(err) {
        hideLoading();
        console.error(err);
    }
}

async function updateMap() {
    const fileInput = document.getElementById('timelineFile');
    if (!fileInput.files.length) { showStatus('No file selected!', true); return; }
    showLoading();
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    try {
        const response = await fetch('/api/update_timeline', { method: 'POST', body: formData });
        const result = await response.json();
        hideLoading();
        showStatus(result.message, result.status === 'error');
        if (result.status === 'success') { loadMarkers(); }
    } catch(err) {
        hideLoading();
        showStatus('Error: ' + err.message, true);
    }
}

async function clearMap() {
    const confirmClear = window.confirm(
        'Clearing the map will remove all data permanently. This action cannot be undone. Do you want to continue?'
    );
    if (!confirmClear) { return; }

    showLoading();
    try {
        const response = await fetch('/api/clear', { method: 'POST' });
        const result = await response.json();
        hideLoading();
        showStatus(result.message, result.status === 'error');
        if (result.status === 'success') { loadMarkers(); }
    } catch(error) {
        hideLoading();
        showStatus('Error: ' + error.message, true);
    }
}

function createModalController(modalId, { getInitialFocus, onClose } = {}) {
    const modal = document.getElementById(modalId);
    if (!modal) { return null; }
    const modalContent = modal.querySelector('.modal-content');
    let focusableElements = [];
    let previouslyFocused = null;

    function setFocusableElements() {
        focusableElements = Array.from(
            modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')
        ).filter((el) => !el.disabled && modal.contains(el));
    }

    function focusInitialElement() {
        const target = typeof getInitialFocus === 'function' ? getInitialFocus() : null;
        if (target && typeof target.focus === 'function') {
            target.focus();
            return;
        }

        if (focusableElements.length > 0) {
            focusableElements[0].focus();
            return;
        }

        if (modalContent && typeof modalContent.focus === 'function') {
            modalContent.focus();
        }
    }

    function handleKeydown(event) {
        if (!modal.classList.contains('open')) { return; }

        if (event.key === 'Escape') {
            event.preventDefault();
            close();
            return;
        }

        if (event.key !== 'Tab') { return; }

        setFocusableElements();
        if (focusableElements.length === 0) {
            event.preventDefault();
            if (modalContent && typeof modalContent.focus === 'function') {
                modalContent.focus();
            }
            return;
        }

        const first = focusableElements[0];
        const last = focusableElements[focusableElements.length - 1];
        const active = document.activeElement;

        if (event.shiftKey) {
            if (active === first || !modal.contains(active)) {
                event.preventDefault();
                last.focus();
            }
        } else if (active === last) {
            event.preventDefault();
            first.focus();
        }
    }

    function open() {
        previouslyFocused = document.activeElement;
        modal.classList.add('open');
        modal.removeAttribute('hidden');
        modal.setAttribute('aria-hidden', 'false');
        setFocusableElements();
        focusInitialElement();
        document.addEventListener('keydown', handleKeydown);
    }

    function close() {
        modal.classList.remove('open');
        modal.setAttribute('aria-hidden', 'true');
        modal.setAttribute('hidden', '');
        document.removeEventListener('keydown', handleKeydown);
        focusableElements = [];
        if (typeof onClose === 'function') {
            onClose();
        }
        if (previouslyFocused && typeof previouslyFocused.focus === 'function') {
            previouslyFocused.focus();
        }
        previouslyFocused = null;
    }

    modal.addEventListener('click', (event) => {
        if (event.target === modal) {
            close();
        }
    });

    return {
        open,
        close,
        refreshFocusableElements: setFocusableElements,
    };
}

function ensureManualPointModal() {
    if (manualPointModalController) { return manualPointModalController; }

    manualPointForm = document.getElementById('manualPointForm');
    const controller = createModalController('manualPointModal', {
        getInitialFocus: () => {
            const form = manualPointForm || document.getElementById('manualPointForm');
            return form ? form.elements['place_name'] : null;
        },
        onClose: () => {
            const form = manualPointForm || document.getElementById('manualPointForm');
            if (form) { form.reset(); }
        },
    });

    if (!controller) { return null; }
    manualPointModalController = controller;

    const cancelButton = document.getElementById('manualPointCancel');
    if (cancelButton) {
        cancelButton.addEventListener('click', (event) => {
            event.preventDefault();
            manualPointModalController.close();
        });
    }

    if (manualPointForm) {
        manualPointForm.addEventListener('submit', handleManualPointSubmit);
    }

    return manualPointModalController;
}

function ensureAliasModal() {
    if (aliasModalController) { return aliasModalController; }

    aliasForm = document.getElementById('aliasForm');
    aliasOriginalNameElement = document.getElementById('aliasOriginalName');

    const controller = createModalController('aliasModal', {
        getInitialFocus: () => {
            const form = aliasForm || document.getElementById('aliasForm');
            return form ? form.elements['alias'] : null;
        },
        onClose: () => {
            aliasTargetMarkerId = null;
            aliasModalContext = { isArchived: false, triggerButton: null };
            const form = aliasForm || document.getElementById('aliasForm');
            if (form) { form.reset(); }
            if (aliasOriginalNameElement) { aliasOriginalNameElement.textContent = ''; }
        },
    });

    if (!controller) { return null; }
    aliasModalController = controller;

    const cancelButton = document.getElementById('aliasCancel');
    if (cancelButton) {
        cancelButton.addEventListener('click', (event) => {
            event.preventDefault();
            aliasModalController.close();
        });
    }

    if (aliasForm) {
        aliasForm.addEventListener('submit', handleAliasSubmit);
    }

    return aliasModalController;
}

function openAliasModal(markerData, options = {}) {
    if (!markerData || !markerData.id) {
        showStatus('This data point cannot be renamed.', true);
        return;
    }

    const controller = ensureAliasModal();
    if (!controller) { return; }

    aliasTargetMarkerId = markerData.id;
    const triggerButton = options.triggerButton || null;
    const isArchived = Boolean(options.isArchived);
    aliasModalContext = { triggerButton, isArchived };

    aliasForm = aliasForm || document.getElementById('aliasForm');
    if (aliasForm) {
        const aliasField = aliasForm.elements['alias'];
        const aliasValueRaw = markerData.alias ?? '';
        const aliasValue = typeof aliasValueRaw === 'string'
            ? aliasValueRaw.trim()
            : String(aliasValueRaw || '').trim();
        if (aliasField) {
            aliasField.value = aliasValue;
        }
    }

    aliasOriginalNameElement = aliasOriginalNameElement || document.getElementById('aliasOriginalName');
    if (aliasOriginalNameElement) {
        const placeRaw = markerData.place ?? '';
        const placeValue = typeof placeRaw === 'string'
            ? placeRaw.trim()
            : String(placeRaw || '').trim();
        aliasOriginalNameElement.textContent = placeValue || 'Unknown';
    }

    controller.open();
    if (controller.refreshFocusableElements) {
        controller.refreshFocusableElements();
    }
}

async function handleAliasSubmit(event) {
    event.preventDefault();

    aliasForm = aliasForm || document.getElementById('aliasForm');
    if (!aliasForm) { return; }

    if (!aliasTargetMarkerId) {
        showStatus('This data point cannot be renamed.', true);
        return;
    }

    const aliasField = aliasForm.elements['alias'];
    const aliasValue = aliasField ? aliasField.value.trim() : '';

    if (aliasValue.length > MAX_ALIAS_LENGTH) {
        showStatus(`Alias must be ${MAX_ALIAS_LENGTH} characters or fewer.`, true);
        if (aliasField) { aliasField.focus(); }
        return;
    }

    const submitButton = aliasForm.querySelector('button[type="submit"]');
    const cancelButton = document.getElementById('aliasCancel');
    const triggerButton = aliasModalContext.triggerButton || null;
    const isArchived = Boolean(aliasModalContext.isArchived);

    if (submitButton) { submitButton.disabled = true; }
    if (cancelButton) { cancelButton.disabled = true; }
    if (triggerButton) { triggerButton.disabled = true; }

    showLoading();

    try {
        const response = await fetch(`/api/markers/${encodeURIComponent(aliasTargetMarkerId)}/alias`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ alias: aliasValue }),
        });
        const result = await response.json().catch(() => ({}));

        if (!response.ok || result.status === 'error') {
            const message = (result && result.message) ? result.message : 'Failed to update alias.';
            throw new Error(message);
        }

        showStatus(result.message || 'Alias updated successfully.');
        if (aliasModalController) {
            aliasModalController.close();
        }
        await loadMarkers();
        if (isArchived) {
            await loadArchivedPointsList();
        }
    } catch (error) {
        showStatus(error.message || 'Failed to update alias.', true);
    } finally {
        hideLoading();
        if (submitButton) { submitButton.disabled = false; }
        if (cancelButton) { cancelButton.disabled = false; }
        if (triggerButton) { triggerButton.disabled = false; }
    }
}

function ensureTripAssignmentModal() {
    if (tripAssignmentModalController) { return tripAssignmentModalController; }

    tripAssignmentForm = document.getElementById('tripAssignmentForm');
    tripSelectElement = document.getElementById('tripSelect');
    newTripNameInput = document.getElementById('newTripName');
    tripSelectHelper = document.getElementById('tripSelectHelper');

    const controller = createModalController('tripAssignmentModal', {
        getInitialFocus: () => {
            tripSelectElement = tripSelectElement || document.getElementById('tripSelect');
            if (tripSelectElement && !tripSelectElement.disabled && tripSelectElement.options.length > 1) {
                return tripSelectElement;
            }
            newTripNameInput = newTripNameInput || document.getElementById('newTripName');
            return newTripNameInput || null;
        },
        onClose: () => {
            tripAssignmentPlaceId = null;
            tripModalContext = { triggerButton: null };
            const form = tripAssignmentForm || document.getElementById('tripAssignmentForm');
            if (form) { form.reset(); }
        },
    });

    if (!controller) { return null; }
    tripAssignmentModalController = controller;

    const cancelButton = document.getElementById('tripAssignmentCancel');
    if (cancelButton) {
        cancelButton.addEventListener('click', (event) => {
            event.preventDefault();
            tripAssignmentModalController.close();
        });
    }

    if (tripAssignmentForm) {
        tripAssignmentForm.addEventListener('submit', handleTripAssignmentSubmit);
    }

    return tripAssignmentModalController;
}

async function populateTripSelect() {
    tripSelectElement = tripSelectElement || document.getElementById('tripSelect');
    tripSelectHelper = tripSelectHelper || document.getElementById('tripSelectHelper');

    if (!tripSelectElement) { return []; }

    tripSelectElement.innerHTML = '';
    const loadingOption = document.createElement('option');
    loadingOption.value = '';
    loadingOption.textContent = 'Loading trips...';
    loadingOption.disabled = true;
    loadingOption.selected = true;
    tripSelectElement.appendChild(loadingOption);
    tripSelectElement.disabled = true;
    tripSelectElement.dataset.hasTrips = 'false';

    try {
        const response = await fetch('/api/trips');
        if (!response.ok) {
            throw new Error('Failed to load trips.');
        }

        const trips = await response.json();
        const tripList = Array.isArray(trips) ? trips : [];
        updateTripsPanel(tripList);

        tripSelectElement.innerHTML = '';

        if (tripList.length === 0) {
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = 'No trips available';
            emptyOption.disabled = true;
            emptyOption.selected = true;
            tripSelectElement.appendChild(emptyOption);
            tripSelectElement.disabled = true;
            tripSelectElement.dataset.hasTrips = 'false';
            if (tripSelectHelper) {
                tripSelectHelper.textContent = 'No trips yet. Enter a name below to create your first trip.';
            }
            return tripList;
        }

        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = 'Select a trip';
        placeholder.disabled = true;
        placeholder.selected = true;
        tripSelectElement.appendChild(placeholder);

        tripList.forEach((trip) => {
            const option = document.createElement('option');
            option.value = trip.id || '';
            if (!option.value) { return; }

            const count = Number(trip.location_count);
            let label = trip.name || 'Untitled Trip';
            if (Number.isFinite(count) && count > 0) {
                label += ` (${count})`;
            }
            option.textContent = label;
            tripSelectElement.appendChild(option);
        });

        tripSelectElement.disabled = false;
        tripSelectElement.dataset.hasTrips = 'true';
        if (tripSelectHelper) {
            tripSelectHelper.textContent = 'Select an existing trip or enter a name to create a new one.';
        }

        return tripList;
    } catch (error) {
        tripSelectElement.innerHTML = '';
        const errorOption = document.createElement('option');
        errorOption.value = '';
        errorOption.textContent = 'Failed to load trips';
        errorOption.disabled = true;
        errorOption.selected = true;
        tripSelectElement.appendChild(errorOption);
        tripSelectElement.disabled = true;
        tripSelectElement.dataset.hasTrips = 'false';
        if (tripSelectHelper) {
            tripSelectHelper.textContent = 'We could not load trips. Please try again.';
        }
        showTripListError(error.message || 'Failed to load trips.');
        throw error;
    }
}

async function openTripAssignmentModal(markerData, options = {}) {
    if (!markerData || !markerData.id) {
        showStatus('This data point cannot be added to a trip.', true);
        return;
    }

    const controller = ensureTripAssignmentModal();
    if (!controller) { return; }

    const triggerButton = options.triggerButton || null;
    tripModalContext = { triggerButton };
    tripAssignmentPlaceId = markerData.id;

    tripAssignmentForm = tripAssignmentForm || document.getElementById('tripAssignmentForm');
    if (tripAssignmentForm) {
        tripAssignmentForm.reset();
    }

    if (triggerButton) { triggerButton.disabled = true; }
    showLoading();

    try {
        await populateTripSelect();
        controller.open();
        if (controller.refreshFocusableElements) {
            controller.refreshFocusableElements();
        }
    } catch (error) {
        console.error('Failed to open trip assignment modal', error);
        tripAssignmentPlaceId = null;
        tripModalContext = { triggerButton: null };
        showStatus(error.message || 'Failed to load trips.', true);
    } finally {
        hideLoading();
        if (triggerButton) { triggerButton.disabled = false; }
    }
}

async function handleTripAssignmentSubmit(event) {
    event.preventDefault();

    tripAssignmentForm = tripAssignmentForm || document.getElementById('tripAssignmentForm');
    if (!tripAssignmentForm) { return; }

    if (!tripAssignmentPlaceId) {
        showStatus('This data point cannot be added to a trip.', true);
        return;
    }

    tripSelectElement = tripSelectElement || document.getElementById('tripSelect');
    newTripNameInput = newTripNameInput || document.getElementById('newTripName');

    const selectedTripId = tripSelectElement && !tripSelectElement.disabled
        ? (tripSelectElement.value || '').trim()
        : '';
    const newTripNameValue = newTripNameInput
        ? newTripNameInput.value.trim()
        : '';

    if (!selectedTripId && !newTripNameValue) {
        showStatus('Select a trip or enter a new trip name.', true);
        if (tripSelectElement && !tripSelectElement.disabled) {
            tripSelectElement.focus();
        } else if (newTripNameInput) {
            newTripNameInput.focus();
        }
        return;
    }

    if (newTripNameValue && newTripNameValue.length > MAX_TRIP_NAME_LENGTH) {
        showStatus(`Trip name must be ${MAX_TRIP_NAME_LENGTH} characters or fewer.`, true);
        if (newTripNameInput) { newTripNameInput.focus(); }
        return;
    }

    const submitButton = tripAssignmentForm.querySelector('button[type="submit"]');
    const cancelButton = document.getElementById('tripAssignmentCancel');
    const triggerButton = tripModalContext.triggerButton || null;

    const previousSelectDisabled = tripSelectElement ? tripSelectElement.disabled : false;
    const previousInputDisabled = newTripNameInput ? newTripNameInput.disabled : false;

    if (submitButton) { submitButton.disabled = true; }
    if (cancelButton) { cancelButton.disabled = true; }
    if (tripSelectElement) { tripSelectElement.disabled = true; }
    if (newTripNameInput) { newTripNameInput.disabled = true; }
    if (triggerButton) { triggerButton.disabled = true; }

    showLoading();

    let encounteredError = false;

    try {
        const payload = { place_id: tripAssignmentPlaceId };
        if (newTripNameValue) {
            payload.new_trip_name = newTripNameValue;
        } else {
            payload.trip_id = selectedTripId;
        }

        const response = await fetch('/api/trips/assign', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
        });
        const result = await response.json().catch(() => ({}));

        if (!response.ok || result.status === 'error') {
            const message = (result && result.message)
                ? result.message
                : 'Failed to add to trip.';
            throw new Error(message);
        }

        showStatus(result.message || 'Location added to trip.');
        if (result && result.trip) {
            upsertTripInList(result.trip);
        } else {
            await loadTripsPanelData();
        }
        if (tripAssignmentModalController) {
            tripAssignmentModalController.close();
        }
    } catch (error) {
        encounteredError = true;
        console.error('Failed to add location to trip', error);
        showStatus(error.message || 'Failed to add to trip.', true);
    } finally {
        hideLoading();
        if (submitButton) { submitButton.disabled = false; }
        if (cancelButton) { cancelButton.disabled = false; }
        if (tripSelectElement) { tripSelectElement.disabled = previousSelectDisabled; }
        if (newTripNameInput) { newTripNameInput.disabled = previousInputDisabled; }
        if (triggerButton) { triggerButton.disabled = false; }
    }

    if (encounteredError) {
        if (newTripNameValue && newTripNameInput) {
            newTripNameInput.focus();
        } else if (tripSelectElement && !tripSelectElement.disabled) {
            tripSelectElement.focus();
        }
    }
}

function ensureArchivedPointsModal() {
    if (archivedPointsModalController) { return archivedPointsModalController; }

    archivedPointsList = document.getElementById('archivedPointsList');
    const controller = createModalController('archivedPointsModal', {
        getInitialFocus: () => document.getElementById('archivedPointsClose'),
    });

    if (!controller) { return null; }
    archivedPointsModalController = controller;

    const closeButton = document.getElementById('archivedPointsClose');
    if (closeButton) {
        closeButton.addEventListener('click', (event) => {
            event.preventDefault();
            archivedPointsModalController.close();
        });
    }

    return archivedPointsModalController;
}

async function handleManualPointSubmit(event) {
    event.preventDefault();
    manualPointForm = manualPointForm || document.getElementById('manualPointForm');
    if (!manualPointForm) { return; }

    const place = manualPointForm.elements['place_name'].value.trim();
    const aliasInput = manualPointForm.elements['alias'];
    const aliasValue = aliasInput ? aliasInput.value.trim() : '';
    const date = manualPointForm.elements['start_date'].value;
    const latValue = manualPointForm.elements['latitude'].value.trim();
    const lonValue = manualPointForm.elements['longitude'].value.trim();

    if (!place) {
        showStatus('Place name is required.', true);
        manualPointForm.elements['place_name'].focus();
        return;
    }

    if (aliasValue.length > MAX_ALIAS_LENGTH) {
        showStatus(`Alias must be ${MAX_ALIAS_LENGTH} characters or fewer.`, true);
        if (aliasInput) { aliasInput.focus(); }
        return;
    }

    if (!date) {
        showStatus('Date is required.', true);
        manualPointForm.elements['start_date'].focus();
        return;
    }

    if (!latValue) {
        showStatus('Latitude is required.', true);
        manualPointForm.elements['latitude'].focus();
        return;
    }

    const lat = Number(latValue);
    if (!Number.isFinite(lat) || lat < -90 || lat > 90) {
        showStatus('Latitude must be a valid number between -90 and 90.', true);
        manualPointForm.elements['latitude'].focus();
        return;
    }

    if (!lonValue) {
        showStatus('Longitude is required.', true);
        manualPointForm.elements['longitude'].focus();
        return;
    }

    const lon = Number(lonValue);
    if (!Number.isFinite(lon) || lon < -180 || lon > 180) {
        showStatus('Longitude must be a valid number between -180 and 180.', true);
        manualPointForm.elements['longitude'].focus();
        return;
    }

    showLoading();
    try {
        const response = await fetch('/api/add_point', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                place_name: place,
                start_date: date,
                latitude: lat,
                longitude: lon,
                source_type: 'manual',
                alias: aliasValue,
            })
        });
        const result = await response.json();
        hideLoading();
        showStatus(result.message, result.status === 'error');
        if (result.status === 'success') {
            if (manualPointModalController) {
                manualPointModalController.close();
            }
            loadMarkers();
        }
    } catch(err) {
        hideLoading();
        showStatus('Error: ' + err.message, true);
    }
}

function addManualPoint() {
    const controller = ensureManualPointModal();
    if (controller) {
        controller.open();
    }
}

function viewArchivedPoints() {
    const controller = ensureArchivedPointsModal();
    if (!controller) { return; }
    controller.open();
    loadArchivedPointsList();
}

async function loadArchivedPointsList() {
    archivedPointsList = archivedPointsList || document.getElementById('archivedPointsList');
    if (!archivedPointsList) { return; }

    archivedPointsList.innerHTML = '<p class="archived-empty">Loading archived data points...</p>';

    try {
        const response = await fetch('/api/archived_markers');
        if (!response.ok) {
            throw new Error('Failed to load archived data points.');
        }
        const markers = await response.json();

        if (!Array.isArray(markers) || markers.length === 0) {
            archivedPointsList.innerHTML = '<p class="archived-empty">No archived data points.</p>';
            return;
        }

        const fragment = document.createDocumentFragment();
        markers.forEach((marker) => {
            const item = document.createElement('div');
            item.className = 'archived-item';
            if (marker.id) {
                item.dataset.markerId = marker.id;
            }
            item.setAttribute('role', 'listitem');

            const details = document.createElement('div');
            details.className = 'archived-item-details';

            const title = document.createElement('div');
            title.className = 'archived-item-place';
            const displayNameRaw = marker.display_name ?? '';
            const displayName = typeof displayNameRaw === 'string'
                ? displayNameRaw.trim()
                : String(displayNameRaw || '').trim();
            const placeRaw = marker.place ?? '';
            const placeText = typeof placeRaw === 'string'
                ? placeRaw.trim()
                : String(placeRaw || '').trim();
            const aliasRaw = marker.alias ?? '';
            const aliasText = typeof aliasRaw === 'string'
                ? aliasRaw.trim()
                : String(aliasRaw || '').trim();
            title.textContent = displayName || placeText || 'Unknown';
            details.appendChild(title);

            if (aliasText && placeText && aliasText !== placeText) {
                const original = document.createElement('div');
                original.className = 'archived-item-place-original';
                original.textContent = placeText;
                details.appendChild(original);
            }

            const meta = document.createElement('div');
            meta.className = 'archived-item-meta';
            const metaParts = [];
            if (marker.date) {
                metaParts.push(marker.date);
            }
            const latNumber = Number(marker.lat);
            const lngNumber = Number(marker.lng);
            if (Number.isFinite(latNumber) && Number.isFinite(lngNumber)) {
                metaParts.push(`${latNumber.toFixed(4)}, ${lngNumber.toFixed(4)}`);
            }
            meta.textContent = metaParts.join(' • ');
            details.appendChild(meta);

            const actionsContainer = document.createElement('div');
            actionsContainer.className = 'archived-item-actions';

            if (marker.id) {
                const renameButton = document.createElement('button');
                renameButton.type = 'button';
                renameButton.className = 'modal-button secondary archived-item-action';
                renameButton.textContent = 'Rename';
                renameButton.addEventListener('click', (event) => {
                    event.preventDefault();
                    openAliasModal(marker, { triggerButton: renameButton, isArchived: true });
                });
                actionsContainer.appendChild(renameButton);
            }

            const unarchiveButton = document.createElement('button');
            unarchiveButton.type = 'button';
            unarchiveButton.className = 'modal-button primary archived-item-action';
            unarchiveButton.textContent = 'Unarchive';
            unarchiveButton.addEventListener('click', (event) => {
                event.preventDefault();
                unarchiveMarker(marker.id, unarchiveButton);
            });
            actionsContainer.appendChild(unarchiveButton);

            item.appendChild(details);
            item.appendChild(actionsContainer);
            fragment.appendChild(item);
        });

        archivedPointsList.innerHTML = '';
        archivedPointsList.appendChild(fragment);
    } catch (error) {
        console.error('Failed to load archived data points', error);
        archivedPointsList.innerHTML = '<p class="archived-empty">Failed to load archived data points.</p>';
    } finally {
        if (archivedPointsModalController) {
            archivedPointsModalController.refreshFocusableElements();
        }
    }
}

function refreshMap() { loadMarkers(); }

async function archiveMarker(markerId, markerInstance, triggerButton) {
    if (!markerId) {
        showStatus('This data point cannot be archived.', true);
        return;
    }

    if (triggerButton) { triggerButton.disabled = true; }
    showLoading();

    try {
        const response = await fetch(`/api/markers/${encodeURIComponent(markerId)}/archive`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ archived: true }),
        });
        const result = await response.json().catch(() => ({}));

        if (!response.ok || result.status === 'error') {
            const message = (result && result.message) ? result.message : 'Failed to archive data point.';
            throw new Error(message);
        }

        showStatus(result.message || 'Data point archived successfully.');
        if (markerInstance && typeof markerInstance.closePopup === 'function') {
            markerInstance.closePopup();
        }
        await loadMarkers();
        const archivedModal = document.getElementById('archivedPointsModal');
        if (archivedModal && archivedModal.classList.contains('open')) {
            await loadArchivedPointsList();
        }
    } catch (error) {
        showStatus(error.message || 'Failed to archive data point.', true);
    } finally {
        hideLoading();
        if (triggerButton) { triggerButton.disabled = false; }
    }
}

async function unarchiveMarker(markerId, triggerButton) {
    if (!markerId) {
        showStatus('This data point cannot be unarchived.', true);
        return;
    }

    if (triggerButton) { triggerButton.disabled = true; }
    showLoading();

    try {
        const response = await fetch(`/api/markers/${encodeURIComponent(markerId)}/archive`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ archived: false }),
        });
        const result = await response.json().catch(() => ({}));

        if (!response.ok || result.status === 'error') {
            const message = (result && result.message) ? result.message : 'Failed to unarchive data point.';
            throw new Error(message);
        }

        showStatus(result.message || 'Data point unarchived successfully.');
        await loadMarkers();
        await loadArchivedPointsList();
    } catch (error) {
        showStatus(error.message || 'Failed to unarchive data point.', true);
    } finally {
        hideLoading();
        if (triggerButton) { triggerButton.disabled = false; }
    }
}

async function deleteMarker(markerId, markerInstance, triggerButton) {
    if (!markerId) {
        showStatus('This data point cannot be deleted.', true);
        return;
    }

    const confirmDelete = window.confirm(
        'Deleting this data point is irreversible. Do you want to continue?'
    );
    if (!confirmDelete) { return; }

    if (triggerButton) { triggerButton.disabled = true; }
    showLoading();

    try {
        const response = await fetch(`/api/markers/${encodeURIComponent(markerId)}`, { method: 'DELETE' });
        const result = await response.json().catch(() => ({}));

        if (!response.ok || result.status === 'error') {
            const message = (result && result.message) ? result.message : 'Failed to delete data point.';
            throw new Error(message);
        }

        showStatus(result.message || 'Data point deleted successfully.');
        if (markerInstance && typeof markerInstance.closePopup === 'function') {
            markerInstance.closePopup();
        }
        await loadMarkers();
    } catch (error) {
        showStatus(error.message || 'Failed to delete data point.', true);
    } finally {
        hideLoading();
        if (triggerButton) { triggerButton.disabled = false; }
    }
}

document.addEventListener('DOMContentLoaded', async () => {
    ensureManualPointModal();
    ensureAliasModal();
    ensureArchivedPointsModal();
    initTripsPanel();
    await loadTripsPanelData();
    const menuControls = document.getElementById('menuControls');
    if (menuControls) {
        const tabs = Array.from(menuControls.querySelectorAll('[role="tab"]'));
        const panels = Array.from(menuControls.querySelectorAll('[role="tabpanel"]'));

        const findPanelForTab = (tab) => {
            if (!tab) { return null; }
            const controlsId = tab.getAttribute('aria-controls');
            if (!controlsId) { return null; }
            return panels.find((panel) => panel.id === controlsId) || null;
        };

        const activateTab = (nextTab) => {
            if (!nextTab) { return; }
            tabs.forEach((tab) => {
                const isActive = tab === nextTab;
                tab.setAttribute('aria-selected', String(isActive));
                tab.setAttribute('tabindex', isActive ? '0' : '-1');
                const panel = findPanelForTab(tab);
                if (panel) {
                    panel.hidden = !isActive;
                }
            });
        };

        const focusTab = (tab) => {
            if (!tab) { return; }
            activateTab(tab);
            tab.focus();
        };

        const focusTabByOffset = (currentIndex, offset) => {
            if (!tabs.length) { return; }
            const nextIndex = (currentIndex + offset + tabs.length) % tabs.length;
            const nextTab = tabs[nextIndex];
            focusTab(nextTab);
        };

        tabs.forEach((tab, index) => {
            tab.addEventListener('click', () => {
                if (tab.getAttribute('aria-selected') === 'true') { return; }
                activateTab(tab);
            });
            tab.addEventListener('keydown', (event) => {
                if (event.key === 'ArrowRight') {
                    event.preventDefault();
                    focusTabByOffset(index, 1);
                } else if (event.key === 'ArrowLeft') {
                    event.preventDefault();
                    focusTabByOffset(index, -1);
                } else if (event.key === 'Home') {
                    event.preventDefault();
                    focusTab(tabs[0]);
                } else if (event.key === 'End') {
                    event.preventDefault();
                    focusTab(tabs[tabs.length - 1]);
                }
            });
        });

        const initiallySelected = tabs.find((tab) => tab.getAttribute('aria-selected') === 'true') || tabs[0];
        activateTab(initiallySelected);
    }
    try {
        const response = await fetch('/api/source_types');
        const types = await response.json();
        const container = document.getElementById('sourceTypeFilters');
        types.forEach(type => {
            const label = document.createElement('label');
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.value = type;
            cb.checked = true;
            cb.addEventListener('change', loadMarkers);
            const text = document.createElement('span');
            text.textContent = getSourceTypeLabel(type);
            label.appendChild(text);
            label.appendChild(cb);
            container.appendChild(label);
        });
    } catch(err) {
        console.error('Failed to load source types', err);
    }
    const startDateInput = document.getElementById('filterStartDate');
    const endDateInput = document.getElementById('filterEndDate');
    const clearDateButton = document.getElementById('clearDateFilters');

    if (startDateInput) { startDateInput.addEventListener('change', loadMarkers); }
    if (endDateInput) { endDateInput.addEventListener('change', loadMarkers); }
    if (clearDateButton) {
        clearDateButton.addEventListener('click', () => {
            if (startDateInput) { startDateInput.value = ''; }
            if (endDateInput) { endDateInput.value = ''; }
            loadMarkers();
        });
    }
    initMap();
    const menu = document.querySelector('.menu-container');
    if (menu) { applyMenuState(menu, menu.classList.contains('open')); }
    document.addEventListener('keydown', (event) => {
        if (event.key !== 'Escape') { return; }
        const manualModalElement = document.getElementById('manualPointModal');
        if (manualModalElement && manualModalElement.classList.contains('open')) { return; }
        const aliasModalElement = document.getElementById('aliasModal');
        if (aliasModalElement && aliasModalElement.classList.contains('open')) { return; }
        const archivedModalElement = document.getElementById('archivedPointsModal');
        if (archivedModalElement && archivedModalElement.classList.contains('open')) { return; }
        const menu = document.querySelector('.menu-container');
        if (menu && menu.classList.contains('open')) {
            event.preventDefault();
            toggleMenu();
            const trigger = menu.querySelector('.menu-toggle');
            if (trigger) { trigger.focus(); }
        }
    });
});

function toggleMenu() {
    const menu = document.querySelector('.menu-container');
    if (!menu) { return; }
    const isOpen = menu.classList.toggle('open');
    applyMenuState(menu, isOpen);
}

function applyMenuState(menu, isOpen) {
    const trigger = menu.querySelector('.menu-toggle');
    const icon = trigger ? trigger.querySelector('.menu-toggle-icon img') : null;
    const label = trigger ? trigger.querySelector('.menu-toggle-text') : null;
    const controls = menu.querySelector('.overlay-controls');

    if (trigger) {
        trigger.setAttribute('aria-expanded', String(isOpen));
        trigger.setAttribute('aria-label', isOpen ? 'Close menu' : 'Open menu');
    }
    if (icon) { icon.setAttribute('src', isOpen ? CLOSE_ICON_PATH : MENU_ICON_PATH); }
    if (label) { label.textContent = isOpen ? 'Close' : 'Menu'; }
    if (controls) {
        controls.setAttribute('aria-hidden', String(!isOpen));
        if (isOpen) { controls.removeAttribute('inert'); }
        else { controls.setAttribute('inert', ''); }
        const focusableSelectors = 'button, [href], input, select, textarea, [tabindex]';
        const focusableElements = controls.querySelectorAll(focusableSelectors);
        focusableElements.forEach((element) => {
            if (isOpen) {
                if (element.dataset.menuPrevTabindex !== undefined) {
                    const previous = element.dataset.menuPrevTabindex;
                    if (previous === '') {
                        element.removeAttribute('tabindex');
                    } else {
                        element.setAttribute('tabindex', previous);
                    }
                    delete element.dataset.menuPrevTabindex;
                } else if (element.getAttribute('tabindex') === '-1') {
                    element.removeAttribute('tabindex');
                }
            } else {
                if (element.dataset.menuPrevTabindex === undefined) {
                    element.dataset.menuPrevTabindex = element.hasAttribute('tabindex') ? element.getAttribute('tabindex') || '' : '';
                }
                element.setAttribute('tabindex', '-1');
            }
        });
    }
}
</script>
</body>
</html>
