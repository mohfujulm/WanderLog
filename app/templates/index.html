<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Wanderlog Map</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}" />
</head>
<body>
<div id="map-container">
    <div id="map"></div>
    <input type="file" id="timelineFile" accept=".json" hidden>
    <div class="menu-container" role="complementary" aria-label="Map controls panel">
        <button class="menu-toggle" id="menuToggle" type="button" aria-label="Open menu" aria-expanded="false" aria-controls="menuControls">
            <span class="menu-toggle-icon" aria-hidden="true">
                <img src="{{ url_for('static', filename='assets/menu-icon.svg') }}" alt="" aria-hidden="true">
            </span>
            <span class="menu-toggle-text">Menu</span>
        </button>
        <div class="overlay-controls" id="menuControls" aria-hidden="true" inert>
            {% if google_auth_enabled %}
            <section class="auth-card" aria-label="Account" data-google-auth-card>
                <div class="auth-card-status" data-auth-status {% if not google_user %}hidden{% endif %}>
                    <span class="auth-card-avatar" data-auth-avatar aria-hidden="true">
                        <img
                            data-auth-avatar-image
                            src="{{ google_user.picture if google_user and google_user.picture else '' }}"
                            alt=""
                            referrerpolicy="no-referrer"
                            {% if not google_user or not google_user.picture %}hidden{% endif %}
                        >
                        <span data-auth-avatar-initial {% if google_user and google_user.picture %}hidden{% endif %}>
                            {% if google_user %}
                                {{ google_user.name[:1] if google_user.name else google_user.email[:1] }}
                            {% endif %}
                        </span>
                    </span>
                    <div class="auth-card-details">
                        <p class="auth-card-title" data-auth-status-title>{% if google_user %}Signed in{% endif %}</p>
                        <p class="auth-card-subtitle" data-auth-status-subtitle>{% if google_user %}{{ google_user.name or google_user.email }}{% endif %}</p>
                    </div>
                </div>
                {% set auth_button_classes = ["overlay-button", "auth-card-action"] %}
                {% if google_user %}
                    {% set auth_button_classes = auth_button_classes + ["overlay-button-secondary"] %}
                    {% set auth_button_href = url_for('main.logout') %}
                    {% set auth_button_label = "Sign Out" %}
                {% else %}
                    {% set auth_button_classes = auth_button_classes + ["overlay-button-google"] %}
                    {% set auth_button_href = url_for('main.google_auth_start') %}
                    {% set auth_button_label = "Sign in with Google" %}
                {% endif %}
                <a
                    class="{{ ' '.join(auth_button_classes) }}"
                    href="{{ auth_button_href }}"
                    data-auth-button
                    data-auth-login-url="{{ url_for('main.google_auth_start') }}"
                    data-auth-logout-url="{{ url_for('main.logout') }}"
                    data-auth-login-label="Sign in with Google"
                    data-auth-logout-label="Sign Out"
                    data-auth-login-class="overlay-button-google"
                    data-auth-logout-class="overlay-button-secondary"
                >
                    <span class="overlay-button-google-icon" data-auth-button-icon aria-hidden="true" {% if google_user %}hidden{% endif %}>
                        <img src="{{ url_for('static', filename='assets/google-logo.svg') }}" alt="">
                    </span>
                    <span data-auth-button-label>{{ auth_button_label }}</span>
                </a>
                <button
                    type="button"
                    class="overlay-button auth-card-albums-button"
                    data-auth-albums-button
                    data-auth-albums-default-label="View Google Photos Albums"
                    data-auth-albums-loading-label="Loading albums..."
                    {% if not google_user %}hidden disabled{% endif %}
                >
                    <span data-auth-albums-button-label>View Google Photos Albums</span>
                </button>
                <div class="auth-card-albums" data-auth-albums-section hidden>
                    <p class="auth-card-albums-empty" data-auth-albums-empty hidden>No albums found for this account.</p>
                    <p class="auth-card-albums-error" data-auth-albums-error role="alert" hidden></p>
                    <ul class="auth-card-albums-list" data-auth-albums-list hidden></ul>
                </div>
            </section>
            {% endif %}
            <div class="overlay-tabs-wrapper">
                <div class="overlay-tabs" role="tablist" aria-label="Menu sections">
                    <button type="button" class="overlay-tab" role="tab" id="menuTabTrips" aria-selected="true" aria-controls="menuPanelTrips">Trips</button>
                    <button type="button" class="overlay-tab" role="tab" id="menuTabControls" aria-selected="false" aria-controls="menuPanelControls" tabindex="-1">Settings</button>
                </div>
                <button type="button" class="overlay-manage-toggle" id="manageModeQuickToggle" data-manage-mode-toggle data-manage-mode-active-class="overlay-manage-toggle-active" data-manage-mode-label-default="Edit" data-manage-mode-label-active="Done" aria-pressed="false">Edit</button>
            </div>
            <div id="menuPanelControls" class="overlay-tab-panel" role="tabpanel" aria-labelledby="menuTabControls">
                <button class="overlay-button" type="button" id="importTimelineButton">Import Timeline Data</button>
                <button class="overlay-button" type="button" id="addManualPointButton">Add a Location Manually</button>
                <button class="overlay-button" type="button" id="clearMapButton">Clear Map</button>
                <button class="overlay-button" type="button" id="refreshMapButton">Refresh Map</button>
                <button class="overlay-button" type="button" id="viewArchivedPointsButton">View Archived Points</button>
                <button class="overlay-button" type="button" id="manageModeToggle" data-manage-mode-toggle data-manage-mode-active-class="overlay-button-active" data-manage-mode-label-default="Enter Manage Mode" data-manage-mode-label-active="Exit Manage Mode">Enter Manage Mode</button>
                <h2 class="overlay-section-title" id="filtersTitle">Filters</h2>
                <div id="sourceTypeFilters" class="checkbox-group" role="group" aria-labelledby="filtersTitle"></div>
                <h2 class="overlay-section-title" id="dateFiltersTitle">Date Range</h2>
                <div class="date-filter-group" id="dateFilters" role="group" aria-labelledby="dateFiltersTitle">
                    <label for="filterStartDate">
                        <span>Start Date</span>
                        <input type="date" id="filterStartDate" name="filterStartDate">
                    </label>
                    <label for="filterEndDate">
                        <span>End Date</span>
                        <input type="date" id="filterEndDate" name="filterEndDate">
                    </label>
                    <div class="date-filter-actions">
                        <button type="button" class="date-filter-clear" id="clearDateFilters">Clear Dates</button>
                    </div>
                </div>
            </div>
            <div id="menuPanelTrips" class="overlay-tab-panel" role="tabpanel" aria-labelledby="menuTabTrips" hidden>
                <div class="trip-panel">
                    <div class="trip-panel-header">
                        <h3 class="trip-panel-heading">Trips</h3>
                        <p class="trip-panel-subtitle">Browse every journey you've created and quickly locate the one you need.</p>
                    </div>
                    <div id="tripListView" class="trip-list-view">
                        <div class="trip-controls">
                            <label class="trip-search">
                                <span class="trip-search-label">Search</span>
                                <input type="search" id="tripSearchInput" name="tripSearch" placeholder="Search trips" autocomplete="off">
                            </label>
                            <div class="trip-sort" role="group" aria-label="Trip sorting">
                                <label class="trip-sort-field" for="tripSortField">
                                    <span class="trip-sort-label">Sort by</span>
                                    <select id="tripSortField" name="tripSortField">
                                        <option value="name">Name</option>
                                        <option value="latest_location_date" selected>Date</option>
                                    </select>
                                </label>
                                <button type="button" class="trip-sort-direction" id="tripSortDirection" aria-label="Sort ascending">
                                    Descending
                                </button>
                            </div>
                        </div>
                        <div class="trip-list-container">
                            <div id="tripListLoading" class="trip-list-message" role="status" aria-live="polite" hidden>Loading trips...</div>
                            <div id="tripListError" class="trip-list-message trip-list-message-error" role="alert" hidden></div>
                            <div id="tripListEmpty" class="trip-list-message" aria-live="polite" hidden>No trips yet. Assign a location to begin your first journey.</div>
                            <div id="tripList" class="trip-list" role="list" hidden></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="status"></div>
    <div id="selectionToolbar" class="selection-toolbar" hidden aria-live="polite">
        <div class="selection-summary">
            <div class="selection-count"><span id="selectionCount">0</span> selected</div>
            <div class="selection-summary-actions">
                <button type="button" class="selection-clear" id="selectionClearButton">Clear selection</button>
                <button type="button" class="selection-exit" id="selectionExitButton">Exit manage mode</button>
            </div>
        </div>
        <div class="selection-actions" role="group" aria-label="Selection actions">
            <button type="button" class="selection-action-button selection-action-trip" id="selectionAddToTripButton" disabled>
                Add to Trip
            </button>
            <button type="button" class="selection-action-button selection-action-remove-trips" id="selectionRemoveTripsButton" disabled>
                Remove from Trips
            </button>
            <button type="button" class="selection-action-button selection-action-archive" id="selectionArchiveButton" disabled>
                Archive
            </button>
            <button type="button" class="selection-action-button selection-action-delete" id="selectionDeleteButton" disabled>
                Delete
            </button>
        </div>
        <p class="selection-hint">Drag on the map to select locations. Hold Alt while dragging to remove from the selection.</p>
    </div>
    <div class="loading-overlay" id="loading">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <div>Loading...</div>
        </div>
    </div>
    <div id="manualPointModal" class="modal-overlay" aria-hidden="true" hidden>
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="manualPointTitle" tabindex="-1">
            <h2 id="manualPointTitle">Add Data Point</h2>
            <form id="manualPointForm">
                <div class="form-group">
                    <label for="manualPlace">Place Name</label>
                    <input type="text" id="manualPlace" name="place_name" autocomplete="off" required>
                </div>
                <div class="form-group">
                    <label for="manualAlias">Custom Name (Optional)</label>
                    <input type="text" id="manualAlias" name="alias" maxlength="120" autocomplete="off" placeholder="e.g. Grandma's House">
                    <p class="form-helper-text">Leave blank to use the place name from your timeline.</p>
                </div>
                <div class="form-group">
                    <label for="manualDescription">Description (Optional)</label>
                    <textarea id="manualDescription" name="description" rows="4" maxlength="2000" placeholder="Add notes about this location"></textarea>
                    <p class="form-helper-text">Optional. Share details or memories about this visit.</p>
                    <p id="manualDescriptionCharacterCount" class="form-helper-text form-helper-counter" aria-live="polite">0 / 2000 characters</p>
                </div>
                <div class="form-group">
                    <label for="manualDate">Date</label>
                    <input type="date" id="manualDate" name="start_date" required>
                </div>
                <div class="form-group">
                    <label for="manualLatitude">Latitude</label>
                    <input type="number" id="manualLatitude" name="latitude" step="any" required>
                </div>
                <div class="form-group">
                    <label for="manualLongitude">Longitude</label>
                    <input type="number" id="manualLongitude" name="longitude" step="any" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="modal-button secondary" id="manualPointCancel">Cancel</button>
                    <button type="submit" class="modal-button primary">Save</button>
                </div>
            </form>
        </div>
    </div>
    <div id="aliasModal" class="modal-overlay" aria-hidden="true" hidden>
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="aliasModalTitle" tabindex="-1">
            <h2 id="aliasModalTitle">Rename Location</h2>
            <form id="aliasForm">
                <div class="form-group">
                    <label for="aliasInput">Custom Name</label>
                    <input type="text" id="aliasInput" name="alias" maxlength="120" autocomplete="off" placeholder="Enter a nickname or leave blank">
                    <p class="form-helper-text">
                        Original place name:
                        <span id="aliasOriginalName" class="alias-modal-original"></span>
                    </p>
                </div>
                <div class="modal-actions">
                    <button type="button" class="modal-button secondary" id="aliasCancel">Cancel</button>
                    <button type="submit" class="modal-button primary">Save</button>
                </div>
            </form>
        </div>
    </div>
    <div id="descriptionModal" class="modal-overlay" aria-hidden="true" hidden>
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="descriptionModalTitle" tabindex="-1">
            <h2 id="descriptionModalTitle">Edit Location Description</h2>
            <form id="descriptionForm">
                <div class="form-group">
                    <label for="descriptionInput">Description</label>
                    <textarea id="descriptionInput" name="description" rows="6" maxlength="2000" placeholder="Add notes about this location"></textarea>
                    <p class="form-helper-text">Optional. Describe what made this visit memorable.</p>
                    <p id="descriptionCharacterCount" class="form-helper-text form-helper-counter" aria-live="polite">0 / 2000 characters</p>
                </div>
                <div class="modal-actions">
                    <button type="button" class="modal-button secondary" id="descriptionCancel">Cancel</button>
                    <button type="submit" class="modal-button primary">Save</button>
                </div>
            </form>
        </div>
    </div>
    <div id="tripAssignmentModal" class="modal-overlay" aria-hidden="true" hidden>
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="tripAssignmentTitle" tabindex="-1">
            <h2 id="tripAssignmentTitle">Add to Trip</h2>
            <form id="tripAssignmentForm">
                <div class="form-group">
                    <label for="tripSelect">Choose a Trip</label>
                    <select id="tripSelect" name="trip_id">
                        <option value="" disabled selected>Loading trips...</option>
                    </select>
                    <p class="form-helper-text" id="tripSelectHelper">
                        Select an existing trip or enter a name to create a new one.
                    </p>
                </div>
                <div class="form-group" id="tripMembershipGroup">
                    <span class="form-group-label">Assigned Trips</span>
                    <div id="tripMembershipList" class="trip-membership-list" role="list" hidden></div>
                    <p class="form-helper-text" id="tripMembershipEmpty">This location is not part of any trips yet.</p>
                </div>
                <div class="form-group">
                    <label for="newTripName">Create New Trip</label>
                    <input type="text" id="newTripName" name="new_trip_name" maxlength="120" autocomplete="off" placeholder="e.g. Summer Getaway">
                    <p class="form-helper-text">Enter a new trip name to create it and add this location.</p>
                </div>
                <div class="modal-actions">
                    <button type="button" class="modal-button secondary" id="tripAssignmentCancel">Cancel</button>
                    <button type="submit" class="modal-button primary">Add to Trip</button>
                </div>
            </form>
        </div>
    </div>
    <div id="archivedPointsModal" class="modal-overlay" aria-hidden="true" hidden>
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="archivedPointsTitle" tabindex="-1">
            <h2 id="archivedPointsTitle">Archived Data Points</h2>
            <div id="archivedPointsList" class="archived-list" role="list">
                <p class="archived-empty">No archived data points.</p>
            </div>
            <div class="modal-actions">
                <button type="button" class="modal-button secondary" id="archivedPointsClose">Close</button>
            </div>
        </div>
    </div>
    <div id="tripProfileOverlay" class="trip-profile-overlay" aria-hidden="true" hidden>
        <article id="tripProfilePanel" class="trip-profile-panel" role="dialog" aria-modal="false" aria-labelledby="tripDetailTitle">
            <div id="tripDetailView" class="trip-detail trip-profile-content" hidden aria-hidden="true">
                <div class="trip-profile-hero">
                    <button type="button" class="trip-profile-close" id="tripDetailBack" aria-label="Close trip profile">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <div class="trip-profile-hero-body">
                        <p class="trip-profile-eyebrow">Trip profile</p>
                        <h2 class="trip-profile-title" id="tripDetailTitle" data-default-text="Trip details">Trip details</h2>
                        <p class="trip-profile-subtitle" id="tripDetailSubtitle" data-default-text="Review the places assigned to this journey.">Review the places assigned to this journey.</p>
                        <div class="trip-profile-name-field" id="tripNameField" hidden>
                            <label class="trip-profile-description-label" for="tripNameInput">Trip name</label>
                            <input type="text" id="tripNameInput" name="name" maxlength="120" autocomplete="off" placeholder="Trip name">
                        </div>
                        <div class="trip-profile-meta" aria-live="polite">
                            <span id="tripDetailCount" class="trip-profile-meta-entry"></span>
                            <span id="tripDetailUpdated" class="trip-profile-meta-entry" hidden></span>
                        </div>
                        <div class="trip-profile-actions" id="tripDetailActions" hidden>
                            <button type="button" class="trip-detail-edit" id="tripDetailEdit">Edit trip</button>
                            <button type="button" class="trip-detail-delete" id="tripDetailDelete">Delete trip</button>
                            <button type="submit" class="trip-detail-save" id="tripDescriptionSave" form="tripDescriptionForm" disabled hidden>Save</button>
                            <button type="button" class="trip-detail-cancel" id="tripDescriptionCancel" hidden disabled>Cancel</button>
                        </div>
                    </div>
                </div>
                <div id="tripDescriptionDisplay" class="trip-profile-description-display" aria-live="polite"></div>
                <div id="tripPhotosSection" class="trip-profile-photos" aria-live="polite" hidden>
                    <div class="trip-profile-photos-header">
                        <h3 class="trip-profile-photos-title">Trip photos</h3>
                        <a id="tripPhotosLink" class="trip-profile-photos-link" href="#" target="_blank" rel="noopener" hidden>Open album</a>
                    </div>
                    <p id="tripPhotosEmpty" class="trip-profile-photos-empty">Add a Google Photos album link to see photos here.</p>
                    <div id="tripPhotosGallery" class="trip-profile-photos-gallery" role="list" hidden></div>
                </div>
                <div class="trip-profile-updated trip-profile-updated-readonly" id="tripDescriptionUpdatedReadOnly" hidden>
                    Last updated <time id="tripDescriptionUpdatedReadOnlyTime"></time>
                </div>
                <form id="tripDescriptionForm" class="trip-profile-description" novalidate hidden>
                    <label class="trip-profile-description-label" for="tripDescriptionInput">Description</label>
                    <textarea id="tripDescriptionInput" name="description" rows="6" maxlength="2000" placeholder="Describe this trip"></textarea>
                    <div class="trip-profile-input-group">
                        <label class="trip-profile-description-label" for="tripPhotosInput">Google Photos album link</label>
                        <input type="url" id="tripPhotosInput" name="google_photos_url" placeholder="https://photos.app.goo.gl/" autocomplete="off">
                        <p class="trip-profile-helper-text">Paste a shared Google Photos album link to display images for this trip.</p>
                    </div>
                    <div class="trip-profile-description-footer">
                        <div class="trip-profile-updated" id="tripDescriptionUpdated" hidden>
                            Last updated <time id="tripDescriptionUpdatedTime"></time>
                        </div>
                    </div>
                </form>
                <div id="tripDescriptionStatus" class="trip-description-status" role="status" aria-live="polite" hidden></div>
                <div class="trip-profile-controls">
                    <div class="trip-detail-controls">
                        <label class="trip-search">
                            <span class="trip-search-label">Search</span>
                            <input type="search" id="tripLocationSearchInput" name="tripLocationSearch" placeholder="Search locations" autocomplete="off">
                        </label>
                        <div class="trip-sort" role="group" aria-label="Location sorting">
                            <label class="trip-sort-field" for="tripLocationSortField">
                                <span class="trip-sort-label">Sort by</span>
                                <select id="tripLocationSortField" name="tripLocationSortField">
                                    <option value="date">Date visited</option>
                                    <option value="name">Name</option>
                                </select>
                            </label>
                            <button type="button" class="trip-sort-direction" id="tripLocationSortDirection" aria-label="Sort descending">
                                Ascending
                            </button>
                        </div>
                    </div>
                </div>
                <div class="trip-profile-locations">
                    <div class="trip-location-list-container">
                        <div id="tripLocationLoading" class="trip-list-message" role="status" aria-live="polite" hidden>Loading locations...</div>
                        <div id="tripLocationError" class="trip-list-message trip-list-message-error" role="alert" hidden></div>
                        <div id="tripLocationEmpty" class="trip-list-message" aria-live="polite" hidden>No locations assigned to this trip yet.</div>
                        <div id="tripLocationList" class="trip-location-list" role="list" hidden></div>
                    </div>
                </div>
            </div>
        </article>
    </div>
</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js" defer></script>
<script>
    window.wanderLogConfig = {
        mapboxToken: "{{ mapbox_token }}",
        assets: {
            menuIcon: "{{ url_for('static', filename='assets/menu-icon.svg') }}",
            closeIcon: "{{ url_for('static', filename='assets/close-icon.svg') }}",
        },
        markerIcons: {
            google_timeline: "{{ url_for('static', filename='assets/marker-pin-blue.svg') }}",
            manual: "{{ url_for('static', filename='assets/marker-pin-orange.svg') }}",
            default: "{{ url_for('static', filename='assets/marker-pin-gray.svg') }}",
        },
        auth: {
            google: {
                enabled: {{ google_auth_enabled | tojson }},
                user: {{ google_user | tojson }},
                loginUrl: "{{ url_for('main.google_auth_start') if google_auth_enabled else '' }}",
                logoutUrl: "{{ url_for('main.logout') if google_auth_enabled else '' }}",
            },
        },
    };
</script>
<script src="{{ url_for('static', filename='js/main.js') }}" defer></script>
</body>
</html>
